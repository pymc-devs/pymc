<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>4. Building models &mdash; pymc v2.0 documentation</title>
    <link rel="stylesheet" href="_static/default.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '2.0',
        COLLAPSE_MODINDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="pymc v2.0 documentation" href="index.html" />
    <link rel="next" title="5. References" href="references.html" />
    <link rel="prev" title="3. Tutorial" href="tutorial.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="references.html" title="5. References"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="tutorial.html" title="3. Tutorial"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">pymc v2.0 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="building-models">
<span id="chap-modelbuilding"></span><h1>4. Building models<a class="headerlink" href="#building-models" title="Permalink to this headline">¶</a></h1>
<p>Bayesian inference begins with specification of a probability model relating
unknown variables to data. PyMC provides three basic building blocks for
Bayesian probability models: <tt class="docutils literal"><span class="pre">Stochastic</span></tt>, <tt class="docutils literal"><span class="pre">Deterministic</span></tt> and
<tt class="docutils literal"><span class="pre">Potential</span></tt>.</p>
<p>A <tt class="docutils literal"><span class="pre">Stochastic</span></tt> object represents a variable whose value is not completely
determined by its parents, and a <tt class="docutils literal"><span class="pre">Deterministic</span></tt> object represents a variable
that is entirely determined by its parents. In object-oriented programming
parlance, <tt class="docutils literal"><span class="pre">Stochastic</span></tt> and <tt class="docutils literal"><span class="pre">Deterministic</span></tt> are subclasses of the
<tt class="docutils literal"><span class="pre">Variable</span></tt> class, which only serves as a template for other classes and is
never actually implemented in models.</p>
<p>The third basic class, <tt class="docutils literal"><span class="pre">Potential</span></tt>, represents &#8216;factor potentials&#8217;
([dawidmarkov,Jordan:2004p5439]_), which are <em>not</em> variables but simply terms
and/or constraints that are multiplied into joint distributions to modify them.
<tt class="docutils literal"><span class="pre">Potential</span></tt> and <tt class="docutils literal"><span class="pre">Variable</span></tt> are subclasses of <tt class="docutils literal"><span class="pre">Node</span></tt>.</p>
<p>PyMC probability models are simply linked groups of <tt class="docutils literal"><span class="pre">Stochastic</span></tt>,
<tt class="docutils literal"><span class="pre">Deterministic</span></tt> and <tt class="docutils literal"><span class="pre">Potential</span></tt> objects. These objects have very limited
awareness of the models in which they are embedded and do not themselves possess
methods for updating their values in fitting algorithms. Objects responsible for
fitting probability models are described in chapter <em class="xref">chap:modelfitting</em>.</p>
<div class="section" id="the-stochastic-class">
<span id="stochastic"></span><h2>4.1. The Stochastic class<a class="headerlink" href="#the-stochastic-class" title="Permalink to this headline">¶</a></h2>
<p>A stochastic variable has the following primary attributes:</p>
<dl class="docutils">
<dt><tt class="docutils literal"><span class="pre">value</span></tt>:</dt>
<dd>The variable&#8217;s current value.</dd>
<dt><tt class="docutils literal"><span class="pre">logp</span></tt>:</dt>
<dd>The log-probability of the variable&#8217;s current value given the values of its
parents.</dd>
</dl>
<p>A stochastic variable can optionally be endowed with a method called <tt class="docutils literal"><span class="pre">random</span></tt>,
which draws a value for the variable given the values of its parents <a class="footnote-reference" href="#id10" id="id1">[1]</a>.
Stochastic objects have the following additional attributes that are generally
specified automatically, and only overridden under particular circumstances:</p>
<dl class="docutils">
<dt><tt class="docutils literal"><span class="pre">parents</span></tt>:</dt>
<dd>A dictionary containing the variable&#8217;s parents. The keys of the dictionary
correspond to the names assigned to the variable&#8217;s parents by the variable, and
the values correspond to the actual parents. For example, the keys of
<img class="math" src="_images/math/f37bba504894945c07a32f5496d74299a37aa51c.png" alt="s"/>&#8216;s parents dictionary in model (<em class="xref">disastermodel</em>) would be
<tt class="docutils literal"><span class="pre">'t_l'</span></tt> and <tt class="docutils literal"><span class="pre">'t_h'</span></tt>. Thanks to Python&#8217;s dynamic typing, the actual parents
(<em>i.e.</em> the values of the dictionary) may be of any class or type.</dd>
<dt><tt class="docutils literal"><span class="pre">children</span></tt>:</dt>
<dd>A set containing the variable&#8217;s children.</dd>
<dt><tt class="docutils literal"><span class="pre">extended_parents</span></tt>:</dt>
<dd>A set containing all the stochastic variables on which the variable depends
either directly or via a sequence of deterministic variables. If the value of
any of these variables changes, the variable will need to recompute its log-
probability.</dd>
<dt><tt class="docutils literal"><span class="pre">extended_children</span></tt>:</dt>
<dd>A set containing all the stochastic variables and potentials that depend on the
variable either directly or via a sequence of deterministic variables. If the
variable&#8217;s value changes, all of these variables will need to recompute their
log-probabilities.</dd>
<dt><tt class="docutils literal"><span class="pre">observed</span></tt>:</dt>
<dd>A flag (boolean) indicating whether the variable&#8217;s value has been observed (is
fixed).</dd>
<dt><tt class="docutils literal"><span class="pre">dtype</span></tt>:</dt>
<dd>A NumPy dtype object (such as <tt class="docutils literal"><span class="pre">numpy.int</span></tt>) that specifies the type of the
variable&#8217;s value to fitting methods. If this is <tt class="xref docutils literal"><span class="pre">None</span></tt> (default) then no type
is enforced.</dd>
</dl>
<div class="section" id="creation-of-stochastic-variables">
<h3>4.1.1. Creation of stochastic variables<a class="headerlink" href="#creation-of-stochastic-variables" title="Permalink to this headline">¶</a></h3>
<p>There are three main ways to create stochastic variables, called the
<strong>automatic</strong>, <strong>decorator</strong>, and <strong>direct</strong> interfaces.</p>
<dl class="docutils">
<dt>Automatic</dt>
<dd><p class="first">Stochastic variables with standard distributions provided by PyMC (see chapter
<em class="xref">chap:distributions</em>) can be created in a single line using special
subclasses of <tt class="docutils literal"><span class="pre">Stochastic</span></tt>. For example, the uniformly-distributed discrete
variable <img class="math" src="_images/math/f37bba504894945c07a32f5496d74299a37aa51c.png" alt="s"/> in (<em class="xref">disastermodel</em>) could be created using the
automatic interface as follows:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">s</span> <span class="o">=</span> <span class="n">DiscreteUniform</span><span class="p">(</span><span class="s">&#39;s&#39;</span><span class="p">,</span> <span class="mf">1851</span><span class="p">,</span> <span class="mf">1962</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mf">1900</span><span class="p">)</span>
</pre></div>
</div>
<p>In addition to the classes in chapter <em class="xref">chap:distributions</em>,
<tt class="docutils literal"><span class="pre">scipy.stats.distributions</span></tt>&#8216; random variable classes are wrapped as
<tt class="docutils literal"><span class="pre">Stochastic</span></tt> subclasses if SciPy is installed. These distributions are in the
submodule <tt class="docutils literal"><span class="pre">pymc.SciPyDistributions</span></tt>.</p>
<p class="last">Users can call the class factory <tt class="docutils literal"><span class="pre">stochastic_from_dist</span></tt> to produce
<tt class="docutils literal"><span class="pre">Stochastic</span></tt> subclasses of their own from probability distributions not
included with PyMC.</p>
</dd>
<dt>Decorator</dt>
<dd><p class="first">Uniformly-distributed discrete stochastic variable <img class="math" src="_images/math/f37bba504894945c07a32f5496d74299a37aa51c.png" alt="s"/> in
(<em class="xref">disastermodel</em>) could alternatively be created from a function that
computes its log-probability as follows:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nd">@stochastic</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">s</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="mf">1900</span><span class="p">,</span> <span class="n">t_l</span><span class="o">=</span><span class="mf">1851</span><span class="p">,</span> <span class="n">t_h</span><span class="o">=</span><span class="mf">1962</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The switchpoint for the rate of disaster occurrence.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="n">t_h</span> <span class="ow">or</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="n">t_l</span><span class="p">:</span>
        <span class="c"># Invalid values</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">numpy</span><span class="o">.</span><span class="n">inf</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c"># Uniform log-likelihood</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">numpy</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">t_h</span> <span class="o">-</span> <span class="n">t_l</span> <span class="o">+</span> <span class="mf">1</span><span class="p">)</span>
</pre></div>
</div>
<p>Note that this is a simple Python function preceded by a Python expression
called a <strong>decorator</strong>, here called <tt class="docutils literal"><span class="pre">&#64;stochastic</span></tt>. Generally, decorators
enhance functions with additional properties or functionality. The
<tt class="docutils literal"><span class="pre">Stochastic</span></tt> object produced by the <tt class="docutils literal"><span class="pre">&#64;stochastic</span></tt> decorator will evaluate
its log-probability using the function <img class="math" src="_images/math/f37bba504894945c07a32f5496d74299a37aa51c.png" alt="s"/>. The <tt class="docutils literal"><span class="pre">value</span></tt> argument, which
is required, provides an initial value for the variable. The remaining arguments
will be assigned as parents of <img class="math" src="_images/math/f37bba504894945c07a32f5496d74299a37aa51c.png" alt="s"/> (<em>i.e.</em> they will populate the
<tt class="docutils literal"><span class="pre">parents</span></tt> dictionary).</p>
<p>To emphasize, the Python function decorated by <tt class="docutils literal"><span class="pre">&#64;stochastic</span></tt> should compute
the <em>log</em>-density or <em>log</em>-probability of the variable. That is why the return
value in the example above is <img class="math" src="_images/math/ed058fcd6d8a1cf83824ac3d1d5764f7b287d51b.png" alt="-\log(t_h-t_l+1)"/> rather than
<img class="math" src="_images/math/0c6327f4ddee72aa8e0b1dd604918a259423362b.png" alt="1/(t_h-t_l+1)"/>.</p>
<p>The <tt class="docutils literal"><span class="pre">value</span></tt> and parents of stochastic variables may be any objects, provided
the log-probability function returns a real number (<tt class="docutils literal"><span class="pre">float</span></tt>). PyMC and SciPy
both provide implementations of several standard probability distributions that
may be helpful for creating custom stochastic variables. Based on informal
comparison using version 2.0, the distributions in PyMC tend to be approximately
an order of magnitude faster than their counterparts in SciPy (using version
0.7).</p>
<p class="last">The decorator <tt class="docutils literal"><span class="pre">stochastic</span></tt> can take several arguments:</p>
</dd>
</dl>
<ul>
<li><dl class="first docutils">
<dt>A flag called <tt class="docutils literal"><span class="pre">trace</span></tt>, which signals to <tt class="docutils literal"><span class="pre">MCMC</span></tt> instances whether an MCMC</dt>
<dd><p class="first last">trace should be kept for this variable. <tt class="docutils literal"><span class="pre">&#64;stochastic(trace</span> <span class="pre">=</span> <span class="pre">False)</span></tt> would
turn tracing off. Defaults to <tt class="xref docutils literal"><span class="pre">True</span></tt>.</p>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>A flag called <tt class="docutils literal"><span class="pre">plot</span></tt>, which signals to <tt class="docutils literal"><span class="pre">MCMC</span></tt> instances whether summary</dt>
<dd><p class="first last">plots should be produced for this variable. Defaults to <tt class="xref docutils literal"><span class="pre">True</span></tt>.</p>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>An integer-valued argument called <tt class="docutils literal"><span class="pre">verbose</span></tt> that controls the amount of</dt>
<dd><p class="first last">output the variable prints to the screen. The default is <img class="math" src="_images/math/bc1f9d9bf8a1b606a4188b5ce9a2af1809e27a89.png" alt="0"/>, no output;
the maximum value is <img class="math" src="_images/math/7cde695f2e4542fd01f860a89189f47a27143b66.png" alt="3"/>.</p>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>A Numpy datatype called <tt class="docutils literal"><span class="pre">dtype</span></tt>. Decorating a log-probability function with</dt>
<dd><blockquote class="first">
<p><tt class="docutils literal"><span class="pre">&#64;stochastic(dtype=int)</span></tt> would produce a discrete random variable. Such a
variable will cast its value to either an integer or an array of integers. The
default dtype is <tt class="docutils literal"><span class="pre">float</span></tt>.</p>
</blockquote>
<p>The decorator interface has a slightly more complex implementation which allows
you to specify a <tt class="docutils literal"><span class="pre">random</span></tt> method for sampling the stochastic variable&#8217;s value
conditional on its parents.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nd">@stochastic</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">s</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="mf">1900</span><span class="p">,</span> <span class="n">t_l</span><span class="o">=</span><span class="mf">1851</span><span class="p">,</span> <span class="n">t_h</span><span class="o">=</span><span class="mf">1962</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The switchpoint for the rate of disaster occurrence.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">logp</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">t_l</span><span class="p">,</span> <span class="n">t_h</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="n">t_h</span> <span class="ow">or</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="n">t_l</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="n">Inf</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="n">log</span><span class="p">(</span><span class="n">t_h</span> <span class="o">-</span> <span class="n">t_l</span> <span class="o">+</span> <span class="mf">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">random</span><span class="p">(</span><span class="n">t_l</span><span class="p">,</span> <span class="n">t_h</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">round</span><span class="p">(</span> <span class="p">(</span><span class="n">t_l</span> <span class="o">-</span> <span class="n">t_h</span><span class="p">)</span> <span class="o">*</span> <span class="n">random</span><span class="p">()</span> <span class="p">)</span> <span class="o">+</span> <span class="n">t_l</span>
</pre></div>
</div>
<p class="last">The stochastic variable again gets its name, docstring and parents from function
<img class="math" src="_images/math/f37bba504894945c07a32f5496d74299a37aa51c.png" alt="s"/>, but in this case it will evaluate its log-probability using the
<tt class="docutils literal"><span class="pre">logp</span></tt> function. The <tt class="docutils literal"><span class="pre">random</span></tt> function will be used when <tt class="docutils literal"><span class="pre">s.random()</span></tt> is
called. Note that <tt class="docutils literal"><span class="pre">random</span></tt> doesn&#8217;t take a <tt class="docutils literal"><span class="pre">value</span></tt> argument, as it generates
values itself. The optional <tt class="docutils literal"><span class="pre">rseed</span></tt> variable provides a seed for the random
number generator. The stochastic&#8217;s <tt class="docutils literal"><span class="pre">value</span></tt> argument is optional when a
<tt class="docutils literal"><span class="pre">random</span></tt> method is provided; if no initial value is provided, it will be drawn
automatically using the <tt class="docutils literal"><span class="pre">random</span></tt> method.</p>
</dd>
</dl>
</li>
</ul>
<dl class="docutils">
<dt>Direct</dt>
<dd><p class="first">It&#8217;s possible to instantiate <tt class="docutils literal"><span class="pre">Stochastic</span></tt> directly:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">s_logp</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">t_l</span><span class="p">,</span> <span class="n">t_h</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="n">t_h</span> <span class="ow">or</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="n">t_l</span><span class="p">:</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">Inf</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">log</span><span class="p">(</span><span class="n">t_h</span> <span class="o">-</span> <span class="n">t_l</span> <span class="o">+</span> <span class="mf">1</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">s_rand</span><span class="p">(</span><span class="n">t_l</span><span class="p">,</span> <span class="n">t_h</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">round</span><span class="p">(</span> <span class="p">(</span><span class="n">t_l</span> <span class="o">-</span> <span class="n">t_h</span><span class="p">)</span> <span class="o">*</span> <span class="n">random</span><span class="p">()</span> <span class="p">)</span> <span class="o">+</span> <span class="n">t_l</span>

<span class="n">s</span> <span class="o">=</span> <span class="n">Stochastic</span><span class="p">(</span> <span class="n">logp</span> <span class="o">=</span> <span class="n">s_logp</span><span class="p">,</span>
                <span class="n">doc</span> <span class="o">=</span> <span class="s">&#39;The switchpoint for the rate of disaster occurrence.&#39;</span><span class="p">,</span>
                <span class="n">name</span> <span class="o">=</span> <span class="s">&#39;s&#39;</span><span class="p">,</span>
                <span class="n">parents</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;t_l&#39;</span><span class="p">:</span> <span class="mf">1851</span><span class="p">,</span> <span class="s">&#39;t_h&#39;</span><span class="p">:</span> <span class="mf">1962</span><span class="p">},</span>
                <span class="n">random</span> <span class="o">=</span> <span class="n">s_rand</span><span class="p">,</span>
                <span class="n">trace</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
                <span class="n">value</span> <span class="o">=</span> <span class="mf">1900</span><span class="p">,</span>
                <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
                <span class="n">rseed</span> <span class="o">=</span> <span class="mf">1.</span><span class="p">,</span>
                <span class="n">observed</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
                <span class="n">cache_depth</span> <span class="o">=</span> <span class="mf">2</span><span class="p">,</span>
                <span class="n">plot</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                <span class="n">verbose</span> <span class="o">=</span> <span class="mf">0</span><span class="p">)</span>
</pre></div>
</div>
<p class="last">Notice that the log-probability and random variate functions are specified
externally and passed to <tt class="docutils literal"><span class="pre">Stochastic</span></tt> as arguments. This is a rather awkward
way to instantiate a stochastic variable; consequently, such implementations
should be rare.</p>
</dd>
</dl>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p><strong>Don&#8217;t update stochastic variables&#8217; values in-place</strong></p>
<p>Stochastic objects&#8217; values should not be updated in-place. This
confuses PyMC&#8217;s caching scheme and corrupts the process used for
accepting or rejecting proposed values in the MCMC algorithm. The only
way a stochastic variable&#8217;s value should be updated is using
statements of the following form:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">A</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">new_value</span>
</pre></div>
</div>
<p>The following are in-place updates and should emph{never} be used:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">A</span><span class="o">.</span><span class="n">value</span> <span class="o">+=</span> <span class="mf">3</span>
<span class="n">A</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="mf">2</span><span class="p">,</span><span class="mf">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">5</span>
<span class="n">A</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">attribute</span> <span class="o">=</span> <span class="n">new_attribute_value</span>
</pre></div>
</div>
<p class="last">This restriction becomes onerous if a step method proposes values for
the elements of an array-valued variable separately. In this case, it
may be preferable to partition the variable into several scalar-valued
variables stored in an array or list.</p>
</div>
</div>
</div>
<div class="section" id="data">
<span id="id2"></span><h2>4.2. Data<a class="headerlink" href="#data" title="Permalink to this headline">¶</a></h2>
<p>Although the data are modelled with statistical distributions, their values
should be treated as immutable (since they have been observed). Data are
represented by <tt class="docutils literal"><span class="pre">Stochastic</span></tt> objects whose <tt class="docutils literal"><span class="pre">observed</span></tt> attribute is set to
<tt class="xref docutils literal"><span class="pre">True</span></tt>. If a stochastic variable&#8217;s <tt class="docutils literal"><span class="pre">observed</span></tt> flag is <tt class="xref docutils literal"><span class="pre">True</span></tt>, its value
cannot be changed, and it won&#8217;t be sampled by the fitting method..</p>
<div class="section" id="declaring-stochastic-variables-to-be-data">
<h3>4.2.1. Declaring stochastic variables to be data<a class="headerlink" href="#declaring-stochastic-variables-to-be-data" title="Permalink to this headline">¶</a></h3>
<p>In each interface, an optional keyword argument <tt class="docutils literal"><span class="pre">observed</span></tt> can be set to
<tt class="xref docutils literal"><span class="pre">True</span></tt>. In the decorator interface, this argument is added to the
<tt class="docutils literal"><span class="pre">&#64;stochastic</span></tt> decorator:</p>
<div class="highlight-python"><pre>@stochastic(observed=True)</pre>
</div>
<p>In the other interfaces, the <tt class="docutils literal"><span class="pre">observed=True</span></tt> argument is added to the
instantiation of the <tt class="docutils literal"><span class="pre">Stochastic</span></tt>, or its subclass:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">x</span> <span class="o">=</span> <span class="n">Binomial</span><span class="p">(</span><span class="s">&#39;x&#39;</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">p</span><span class="p">,</span> <span class="n">observed</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
</div>
<p>Alternatively, in the decorator interface only, a <tt class="docutils literal"><span class="pre">Stochastic</span></tt> object&#8217;s
<tt class="docutils literal"><span class="pre">observed</span></tt> flag can be set to true by stacking an <tt class="docutils literal"><span class="pre">&#64;observed</span></tt> decorator on
top of the <tt class="docutils literal"><span class="pre">&#64;stochastic</span></tt> decorator:</p>
<div class="highlight-python"><pre>@observed
@stochastic(dtype=int)</pre>
</div>
</div>
</div>
<div class="section" id="the-deterministic-class">
<span id="deterministic"></span><h2>4.3. The Deterministic class<a class="headerlink" href="#the-deterministic-class" title="Permalink to this headline">¶</a></h2>
<p>The <tt class="docutils literal"><span class="pre">Deterministic</span></tt> class represents variables whose values are completely
determined by the values of their parents. For example, in model
(<em class="xref">disastermodel</em>), <img class="math" src="_images/math/b55ca7a0aa88ab7d58f4fc035317fdac39b17861.png" alt="r"/> is a <tt class="docutils literal"><span class="pre">deterministic</span></tt> variable. Recall it was
defined by</p>
<div class="math">
<p><img src="_images/math/ab066a06c41fef3196d89b51efb572bf1e48cde0.png" alt="\begin{eqnarray*}
    r_t=\left\{\begin{array}{ll}
        e &amp; t\le s\\ l &amp; t&gt;s
        \end{array}\right.,
\end{eqnarray*}" />
</div></p><p>so <img class="math" src="_images/math/b55ca7a0aa88ab7d58f4fc035317fdac39b17861.png" alt="r"/>&#8216;s value can be computed exactly from the values of its parents
<img class="math" src="_images/math/a3a59bb1293ee3f6dec19de4019a7178874219ae.png" alt="e"/>, <img class="math" src="_images/math/9b25f8e64b484493fda944d25cad453423041fe6.png" alt="l"/> and <img class="math" src="_images/math/f37bba504894945c07a32f5496d74299a37aa51c.png" alt="s"/>.</p>
<p>A <tt class="docutils literal"><span class="pre">deterministic</span></tt> variable&#8217;s most important attribute is <tt class="docutils literal"><span class="pre">value</span></tt>, which
gives the current value of the variable given the values of its parents. Like
<tt class="docutils literal"><span class="pre">Stochastic</span></tt>&#8216;s <tt class="docutils literal"><span class="pre">logp</span></tt> attribute, this attribute is computed on-demand and
cached for efficiency.</p>
<p>A Deterministic variable has the following additional attributes:</p>
<dl class="docutils">
<dt><tt class="docutils literal"><span class="pre">parents</span></tt>:</dt>
<dd>A dictionary containing the variable&#8217;s parents. The keys of the dictionary
correspond to the names assigned to the variable&#8217;s parents by the variable, and
the values correspond to the actual parents. Thanks to Python&#8217;s dynamic typing,
parents may be of any class or type.</dd>
<dt><tt class="docutils literal"><span class="pre">children</span></tt>:</dt>
<dd>A set containing the variable&#8217;s children, which must be nodes.</dd>
</dl>
<p>Deterministic variables have no methods.</p>
<div class="section" id="creation-of-deterministic-variables">
<h3>4.3.1. Creation of deterministic variables<a class="headerlink" href="#creation-of-deterministic-variables" title="Permalink to this headline">¶</a></h3>
<p>Deterministic variables are less complicated than stochastic variables, and have
similar <strong>automatic</strong>, <strong>decorator</strong>, and <strong>direct</strong> interfaces:</p>
<dl class="docutils">
<dt>Automatic</dt>
<dd><p class="first">A handful of common functions have been wrapped in Deterministic objects. These
are brief enough to list:</p>
<dl class="docutils">
<dt><tt class="docutils literal"><span class="pre">LinearCombination</span></tt>:</dt>
<dd>Has two parents <img class="math" src="_images/math/26eeb5258ca5099acf8fe96b2a1049c48c89a5e6.png" alt="x"/> and <img class="math" src="_images/math/092e364e1d9d19ad5fffb0b46ef4cc7f2da02c1c.png" alt="y"/>, both of which must be iterable (<em>i.e.</em>
vector-valued). This function returns:</dd>
<dt><tt class="docutils literal"><span class="pre">Index</span></tt>:</dt>
<dd>Has three parents <img class="math" src="_images/math/26eeb5258ca5099acf8fe96b2a1049c48c89a5e6.png" alt="x"/>, <img class="math" src="_images/math/092e364e1d9d19ad5fffb0b46ef4cc7f2da02c1c.png" alt="y"/> and <tt class="docutils literal"><span class="pre">index</span></tt>. <img class="math" src="_images/math/26eeb5258ca5099acf8fe96b2a1049c48c89a5e6.png" alt="x"/> and <img class="math" src="_images/math/092e364e1d9d19ad5fffb0b46ef4cc7f2da02c1c.png" alt="y"/>
must be iterables, <tt class="docutils literal"><span class="pre">index</span></tt> must be valued as an integer. Index returns the dot
product of <img class="math" src="_images/math/26eeb5258ca5099acf8fe96b2a1049c48c89a5e6.png" alt="x"/> and <img class="math" src="_images/math/092e364e1d9d19ad5fffb0b46ef4cc7f2da02c1c.png" alt="y"/> for the elements specified by <tt class="docutils literal"><span class="pre">index</span></tt>:
<tt class="docutils literal"><span class="pre">Index</span></tt> is useful for implementing dynamic models, in which the parent-child
connections change.</dd>
<dt><tt class="docutils literal"><span class="pre">Lambda</span></tt>:</dt>
<dd>Converts an anonymous function (in Python, called <strong>lambda functions</strong>) to a
<tt class="docutils literal"><span class="pre">Deterministic</span></tt> instance on a single line.</dd>
<dt><tt class="docutils literal"><span class="pre">CompletedDirichlet</span></tt>:</dt>
<dd>PyMC represents Dirichlet variables of length <img class="math" src="_images/math/8c325612684d41304b9751c175df7bcc0f61f64f.png" alt="k"/> by the first <img class="math" src="_images/math/7dc6fab4c2fdb4e9046030fbfdcf6ea721b05602.png" alt="k-1"/>
elements; since they must sum to 1, the <img class="math" src="_images/math/9f95e9fc37dc276d9cfc43aba335cde356371cac.png" alt="k^{th}"/> element is determined by
the others. <tt class="docutils literal"><span class="pre">CompletedDirichlet</span></tt> appends the <img class="math" src="_images/math/9f95e9fc37dc276d9cfc43aba335cde356371cac.png" alt="k^{th}"/> element to the
value of its parent <img class="math" src="_images/math/9ffb448918db29f2a72f8f87f421b3b3cad18f95.png" alt="D"/>.</dd>
<dt><tt class="docutils literal"><span class="pre">Logit</span></tt>, <tt class="docutils literal"><span class="pre">InvLogit</span></tt>, <tt class="docutils literal"><span class="pre">StukelLogit</span></tt>, <tt class="docutils literal"><span class="pre">StukelInvLogit</span></tt>:</dt>
<dd>Various common link functions for generalized linear models.</dd>
</dl>
<p class="last">It&#8217;s a good idea to use these classes when feasible, because certain fitting
methods (Gibbs step methods in particular) implicitly know how to take them into
account.</p>
</dd>
<dt>Decorator</dt>
<dd><p class="first">A deterministic variable can be created via a decorator in a way very similar to
<tt class="docutils literal"><span class="pre">Stochastic</span></tt>&#8216;s decorator interface:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nd">@deterministic</span>
<span class="k">def</span> <span class="nf">r</span><span class="p">(</span><span class="n">switchpoint</span> <span class="o">=</span> <span class="n">s</span><span class="p">,</span> <span class="n">early_rate</span> <span class="o">=</span> <span class="n">e</span><span class="p">,</span> <span class="n">late_rate</span> <span class="o">=</span> <span class="n">l</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The rate of disaster occurrence.&quot;&quot;&quot;</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
    <span class="n">value</span><span class="p">[:</span><span class="n">switchpoint</span><span class="p">]</span> <span class="o">=</span> <span class="n">early_rate</span>
    <span class="n">value</span><span class="p">[</span><span class="n">switchpoint</span><span class="p">:]</span> <span class="o">=</span> <span class="n">late_rate</span>
    <span class="k">return</span> <span class="n">value</span>
</pre></div>
</div>
<p>Notice that rather than returning the log-probability, as is the case for
<tt class="docutils literal"><span class="pre">Stochastic</span></tt> objects, the function returns the value of the deterministic
object, given its parents. This return value may be of any type, as is suitable
for the problem at hand. Also notice that, unlike for <tt class="docutils literal"><span class="pre">Stochastic</span></tt> objects,
there is no <tt class="docutils literal"><span class="pre">value</span></tt> argument passed, since the value is calculated
deterministically by the function itself. Arguments&#8217; keys and values are
converted into a parent dictionary as with <tt class="docutils literal"><span class="pre">Stochastic</span></tt>&#8216;s short interface. The
<tt class="docutils literal"><span class="pre">deterministic</span></tt> decorator can take <tt class="docutils literal"><span class="pre">trace</span></tt>, <tt class="docutils literal"><span class="pre">verbose</span></tt> and <tt class="docutils literal"><span class="pre">plot</span></tt>
arguments, like the <tt class="docutils literal"><span class="pre">stochastic</span></tt> decorator <a class="footnote-reference" href="#id11" id="id3">[2]</a>.</p>
<p class="last">Of course, since deterministic nodes are not expected to generate random
variates, the longer implementation of the decorator interface available to
<tt class="docutils literal"><span class="pre">Stochastic</span></tt> objects is not relevant here.</p>
</dd>
<dt>Direct</dt>
<dd><p class="first">Deterministic objects can also be instantiated directly, by passing the
evaluation function to the <tt class="docutils literal"><span class="pre">Deterministic</span></tt> class as an argument:</p>
<div class="last highlight-python"><pre>def r_eval(switchpoint = s, early_rate = e, late_rate = l):
    value = zeros(N)
    value[:switchpoint] = early_rate
    value[switchpoint:] = late_rate
    return value

r = Deterministic(  eval = r_eval,
                    name = 'r',
                    parents = {'switchpoint': s, 'early_rate': e, 'late_rate': l}),
                    doc = 'The rate of disaster occurrence.',
                    trace = True,
                    verbose = 0,
                    dtype=float,
                    plot=False,
                    cache_depth = 2)</pre>
</div>
</dd>
</dl>
</div>
</div>
<div class="section" id="containers">
<h2>4.4. Containers<a class="headerlink" href="#containers" title="Permalink to this headline">¶</a></h2>
<p>In some situations it would be inconvenient to assign a unique label to each
parent of some variable. Consider <img class="math" src="_images/math/092e364e1d9d19ad5fffb0b46ef4cc7f2da02c1c.png" alt="y"/> in the following model:</p>
<div class="math">
<p><img src="_images/math/3937a2f62fe3cba791f671fdab3604727190f4e8.png" alt="\begin{align*}
    x_0 &amp;\sim \textup N (0,\tau_x)\\
    x_{i+1}|x_i &amp;\sim \textup{N}(x_i, \tau_x)\\
    &amp;&amp;i=0,\ldots, N-2\\
    y|x &amp;\sim \textup N \left(\sum_{i=0}^{N-1}x_i^2,\tau_y\right)
\end{align*}" />
</div></p><p>Here, <img class="math" src="_images/math/092e364e1d9d19ad5fffb0b46ef4cc7f2da02c1c.png" alt="y"/> depends on every element of the Markov chain <img class="math" src="_images/math/26eeb5258ca5099acf8fe96b2a1049c48c89a5e6.png" alt="x"/>, but we
wouldn&#8217;t want to manually enter <img class="math" src="_images/math/fc97ef67268cd4e91bacdf12b8901d7036c9a056.png" alt="N"/> parent labels <tt class="docutils literal"><span class="pre">`x_0'</span></tt>, <tt class="docutils literal"><span class="pre">`x_1'</span></tt>,
etc.</p>
<p>This situation can be handled naturally in PyMC:</p>
<div class="highlight-python"><pre>x_0 = Normal(`x_0', mu=0, tau=1)

# Initialize array of stochastics
x = [x_0]

# Loop over number of elements in N
for i in range(1,N):

   # Instantiate Normal stochastic, based on value of previous element in x
   xi = Normal(`x_%i' % i, mu=x[-1], tau=1)

   # Append to x
   x.append(xi)

@observed
@stochastic
def y(value = 1, mu = x, tau = 100):

    # Initialize sum of mu's
    mu_sum = 0

    for i in range(N):
        # Append squared mu
        mu_sum += mu[i] ** 2

    # Calculate and return log-likelihood
    return normal_like(value, mu_sum, tau)</pre>
</div>
<p>PyMC automatically wraps list <img class="math" src="_images/math/26eeb5258ca5099acf8fe96b2a1049c48c89a5e6.png" alt="x"/> in an appropriate <tt class="docutils literal"><span class="pre">Container</span></tt> class.
The  expression <tt class="docutils literal"><span class="pre">`x_%i'</span> <span class="pre">%</span> <span class="pre">i</span></tt> labels each <tt class="docutils literal"><span class="pre">Normal</span></tt> object in the container
with the appropriate index <img class="math" src="_images/math/34857b3ba74ce5cd8607f3ebd23e9015908ada71.png" alt="i"/>; so if <tt class="docutils literal"><span class="pre">i=1</span></tt>, the name of the
corresponding element becomes <tt class="docutils literal"><span class="pre">`x_1'</span></tt>.</p>
<p>Containers, like variables, have an attribute called <tt class="docutils literal"><span class="pre">value</span></tt>. This attribute
returns a copy of the (possibly nested) iterable that was passed into the
container function, but with each variable inside replaced with its
corresponding value.</p>
<p>Containers can currently be constructed from lists, tuples, dictionaries, Numpy
arrays, modules, sets or any object with a <tt class="docutils literal"><span class="pre">__dict__</span></tt> attribute. Variables and
non-variables can be freely mixed in these containers, and different types of
containers can be nested <a class="footnote-reference" href="#id12" id="id4">[3]</a>. Containers attempt to behave like the objects
they wrap. All containers are subclasses of <tt class="docutils literal"><span class="pre">ContainerBase</span></tt>.</p>
<p>Containers have the following useful attributes in addition to <tt class="docutils literal"><span class="pre">value</span></tt>:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">variables</span></tt></li>
<li><tt class="docutils literal"><span class="pre">stochastics</span></tt></li>
<li><tt class="docutils literal"><span class="pre">potentials</span></tt></li>
<li><tt class="docutils literal"><span class="pre">deterministics</span></tt></li>
<li><tt class="docutils literal"><span class="pre">data_stochastics</span></tt></li>
<li><tt class="docutils literal"><span class="pre">step_methods</span></tt>.</li>
</ul>
<p>Each of these attributes is a set containing all the objects of each type in a
container, and within any containers in the container.</p>
</div>
<div class="section" id="the-potential-class">
<span id="potential"></span><h2>4.5. The Potential class<a class="headerlink" href="#the-potential-class" title="Permalink to this headline">¶</a></h2>
<p>The joint density corresponding to model (<em class="xref">disastermodel</em>) can be written
as follows:</p>
<div class="math">
<p><img src="_images/math/c818cb56ff026e8567a172a1506fa36698c8869e.png" alt="\begin{eqnarray*}
    p(D,s,l,e) = p(D|s,l,e) p(s) p(l) p(e).
\end{eqnarray*}" />
</div></p><p>Each factor in the joint distribution is a proper, normalized probability
distribution for one of the variables conditional on its parents. Such factors
are contributed by <tt class="docutils literal"><span class="pre">Stochastic</span></tt> objects.</p>
<p>In some cases, it&#8217;s nice to be able to modify the joint density by incorporating
terms that don&#8217;t correspond to probabilities of variables conditional on
parents, for example:</p>
<div class="math">
<p><img src="_images/math/511420ee9e915244c95cefa910eef173ec5b4f82.png" alt="\begin{eqnarray*}
    p(x_0, x_2, \ldots x_{N-1}) \propto \prod_{i=0}^{N-2} \psi_i(x_i, x_{i+1}).
\end{eqnarray*}" />
</div></p><p>In other cases we may want to add probability terms to existing models. For
example, suppose we want to constrain the difference between <img class="math" src="_images/math/a3a59bb1293ee3f6dec19de4019a7178874219ae.png" alt="e"/> and
<img class="math" src="_images/math/9b25f8e64b484493fda944d25cad453423041fe6.png" alt="l"/> in (<em class="xref">disastermodel</em>) to be less than 1, so that the joint density
becomes</p>
<div class="math">
<p><img src="_images/math/51262bb4ed6a8d20fc2824abe182d0430fece40b.png" alt="\begin{eqnarray*}
    p(D,s,l,e) \propto p(D|s,l,e) p(s) p(l) p(e) I(|e-l|&lt;1).
\end{eqnarray*}" />
</div></p><p>It&#8217;s possible to express this constraint by adding variables to the model, or by
grouping <img class="math" src="_images/math/a3a59bb1293ee3f6dec19de4019a7178874219ae.png" alt="e"/> and <img class="math" src="_images/math/9b25f8e64b484493fda944d25cad453423041fe6.png" alt="l"/> to form a vector-valued variable, but it&#8217;s
uncomfortable to do so.</p>
<p>Arbitrary factors such as <img class="math" src="_images/math/8ada738001410f131563551fb68731e4f302048d.png" alt="\psi"/> and the indicator function
<img class="math" src="_images/math/9386f1c1fd70eb885d71df61fcf9c51ff78eaba2.png" alt="I(|e-l|&lt;1)"/> are implemented by objects of class <tt class="docutils literal"><span class="pre">Potential</span></tt>
([dawidmarkov] and [Jordan:2004p5439] call these terms &#8216;factor potentials&#8217;).
Bayesian hierarchical notation (cf model (<em class="xref">disastermodel</em>)) doesn&#8217;t
accomodate these potentials. They are often used in cases where there is no
natural dependence hierarchy, such as the first example above (which is known as
a Markov random field). They are also useful for expressing &#8216;soft data&#8217;
[Christakos:2002p5506] as in the second example above.</p>
<p>Potentials have one important attribute, <tt class="docutils literal"><span class="pre">logp</span></tt>, the log of their current
probability or probability density value given the values of their parents. The
only other additional attribute of interest is <tt class="docutils literal"><span class="pre">parents</span></tt>, a dictionary
containing the potential&#8217;s parents. Potentials have no methods. They have no
<tt class="docutils literal"><span class="pre">trace</span></tt> attribute, because they are not variables. They cannot serve as
parents of variables (for the same reason), so they have no <tt class="docutils literal"><span class="pre">children</span></tt>
attribute.</p>
<div class="section" id="an-example-of-soft-data">
<h3>4.5.1. An example of soft data<a class="headerlink" href="#an-example-of-soft-data" title="Permalink to this headline">¶</a></h3>
<p>The role of potentials can be confusing, so we will provide another example: we
have a dataset <img class="math" src="_images/math/e0d2bf360290fd61d1c1557e763f2622363b3d35.png" alt="t"/> consisting of the days on which several marked animals
were recaptured. We believe that the probability <img class="math" src="_images/math/ad28c83c99a8fd0dd2e2e594c9d02ee532765a0a.png" alt="S"/> that an animal is not
recaptured on any given day can be explained by a covariate vector <img class="math" src="_images/math/26eeb5258ca5099acf8fe96b2a1049c48c89a5e6.png" alt="x"/>. We
model this situation as follows:</p>
<div class="math">
<p><img src="_images/math/642494a28fd2c6caf4912d8d07d8782a3cba7f6c.png" alt="\begin{eqnarray*}
    t_i|S_i \sim \textup{Geometric}(S_i), &amp; i=1\ldots N\\
    S_i = \textup{logit}^{-1}(\beta x_i), &amp;i=1\ldots N\\
    \beta\sim \textup{N}(\mu_\beta, V_\beta).
\end{eqnarray*}" />
</div></p><p>So far, so good. Now suppose we have some knowledge of other related experiments
and we have a good idea of what <img class="math" src="_images/math/ad28c83c99a8fd0dd2e2e594c9d02ee532765a0a.png" alt="S"/> will be independent of the value of
<img class="math" src="_images/math/fdb63b9e51abe6bbb16acfb5d7b773ddbb5bf4a8.png" alt="\beta"/>. It&#8217;s not obvious how to work this &#8216;soft data&#8217;, because as we&#8217;ve
written the model <img class="math" src="_images/math/ad28c83c99a8fd0dd2e2e594c9d02ee532765a0a.png" alt="S"/> is completely determined by <img class="math" src="_images/math/fdb63b9e51abe6bbb16acfb5d7b773ddbb5bf4a8.png" alt="\beta"/>. There are
three options within the strict Bayesian hierarchical framework:</p>
<ul class="simple">
<li>Work the soft data into the prior on <img class="math" src="_images/math/fdb63b9e51abe6bbb16acfb5d7b773ddbb5bf4a8.png" alt="\beta"/>.</li>
<li>Incorporate the data from the previous experiments explicitly into the model.</li>
<li>Refactor the model so that <img class="math" src="_images/math/ad28c83c99a8fd0dd2e2e594c9d02ee532765a0a.png" alt="S"/> is at the bottom of the hierarchy, and
assign the prior directly.</li>
</ul>
<p>Factor potentials provide a convenient way to incorporate the soft data without
the need for such major modifications. We can simply modify the joint
distribution from</p>
<div class="math">
<p><img src="_images/math/3920cf6df062000d77cbca3d4f33177d51d35016.png" alt="\begin{eqnarray*}
    p(t|S(x,\beta)) p(\beta)
\end{eqnarray*}" />
</div></p><p>to</p>
<div class="math">
<p><img src="_images/math/df2a27f4e86c8eceedb461d469e50ce314ece9e1.png" alt="\begin{eqnarray*}
    \gamma(S) p(t|S(x,\beta)) p(\beta),
\end{eqnarray*}" />
</div></p><p>where the value of <img class="math" src="_images/math/66981fa3920210c6ad8dbe5e968783d5dd7520c3.png" alt="\gamma"/> is large if <img class="math" src="_images/math/ad28c83c99a8fd0dd2e2e594c9d02ee532765a0a.png" alt="S"/>&#8216;s value is plausible
(based on our external information) and small otherwise. We do not know the
normalizing constant for the new distribution, but we don&#8217;t need it to use most
popular fitting algorithms. It&#8217;s a good idea to check the induced priors on
<img class="math" src="_images/math/ad28c83c99a8fd0dd2e2e594c9d02ee532765a0a.png" alt="S"/> and <img class="math" src="_images/math/fdb63b9e51abe6bbb16acfb5d7b773ddbb5bf4a8.png" alt="\beta"/> for sanity. This can be done in PyMC by fitting the
model with the data <img class="math" src="_images/math/e0d2bf360290fd61d1c1557e763f2622363b3d35.png" alt="t"/> removed.</p>
<p>It&#8217;s important to understand that <img class="math" src="_images/math/66981fa3920210c6ad8dbe5e968783d5dd7520c3.png" alt="\gamma"/> is not a variable, so it does
not have a value. That means, among other things, there will be no
<img class="math" src="_images/math/66981fa3920210c6ad8dbe5e968783d5dd7520c3.png" alt="\gamma"/> column in MCMC traces. <img class="math" src="_images/math/66981fa3920210c6ad8dbe5e968783d5dd7520c3.png" alt="\gamma"/> is simply an extra term
that we are incorporating in the joint distribution.</p>
</div>
<div class="section" id="creation-of-potentials">
<h3>4.5.2. Creation of Potentials<a class="headerlink" href="#creation-of-potentials" title="Permalink to this headline">¶</a></h3>
<p>There are two ways to create potentials:</p>
<dl class="docutils">
<dt>Decorator</dt>
<dd><p class="first">A potential can be created via a decorator in a way very similar to
<tt class="docutils literal"><span class="pre">Deterministic</span></tt>&#8216;s decorator interface:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nd">@potential</span>
<span class="k">def</span> <span class="nf">psi_i</span><span class="p">(</span><span class="n">x_lo</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">x_hi</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mf">1</span><span class="p">]):</span>
    <span class="sd">&quot;&quot;&quot;A pair potential&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="o">-</span><span class="p">(</span><span class="n">xlo</span> <span class="o">-</span> <span class="n">xhi</span><span class="p">)</span><span class="o">**</span><span class="mf">2</span>
</pre></div>
</div>
<p class="last">The function supplied should return the potential&#8217;s current <em>log</em>-probability or
<em>log</em>-density as a Numpy <tt class="docutils literal"><span class="pre">float</span></tt>. The <tt class="docutils literal"><span class="pre">potential</span></tt> decorator can take
<tt class="docutils literal"><span class="pre">verbose</span></tt> and <tt class="docutils literal"><span class="pre">cache_depth</span></tt> arguments like the <tt class="docutils literal"><span class="pre">stochastic</span></tt> decorator.</p>
</dd>
<dt>Direct</dt>
<dd><p class="first">The same potential could be created directly as follows:</p>
<div class="last highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">psi_i_logp</span><span class="p">(</span><span class="n">x_lo</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">x_hi</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mf">1</span><span class="p">]):</span>
    <span class="k">return</span> <span class="o">-</span><span class="p">(</span><span class="n">xlo</span> <span class="o">-</span> <span class="n">xhi</span><span class="p">)</span><span class="o">**</span><span class="mf">2</span>

<span class="n">psi_i</span> <span class="o">=</span> <span class="n">Potential</span><span class="p">(</span>  <span class="n">logp</span> <span class="o">=</span> <span class="n">psi_i_logp</span><span class="p">,</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="s">&#39;psi_i&#39;</span><span class="p">,</span>
                    <span class="n">parents</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;xlo&#39;</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s">&#39;xhi&#39;</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mf">1</span><span class="p">]},</span>
                    <span class="n">doc</span> <span class="o">=</span> <span class="s">&#39;A pair potential&#39;</span><span class="p">,</span>
                    <span class="n">verbose</span> <span class="o">=</span> <span class="mf">0</span><span class="p">,</span>
                    <span class="n">cache_depth</span> <span class="o">=</span> <span class="mf">2</span><span class="p">)</span>
</pre></div>
</div>
</dd>
</dl>
</div>
</div>
<div class="section" id="graphing-models">
<span id="graphical"></span><h2>4.6. Graphing models<a class="headerlink" href="#graphing-models" title="Permalink to this headline">¶</a></h2>
<p>The function <tt class="docutils literal"><span class="pre">graph</span></tt> in <tt class="docutils literal"><span class="pre">pymc.graph</span></tt> draws graphical representations of
<tt class="docutils literal"><span class="pre">Model</span></tt> (Chapter <em class="xref">chap:modelfitting</em>) instances using GraphViz via the
Python package PyDot (if they are installed). See [dawidmarkov] and
[Jordan:2004p5439] for more discussion of useful information that can be read
off of graphical models. Note that these authors do not consider deterministic
variables.</p>
<p>The symbol for stochastic variables is an ellipse. Parent-child relationships
are indicated by arrows. These arrows point from parent to child and are labeled
with the names assigned to the parents by the children. PyMC&#8217;s symbol for
deterministic variables is a downward-pointing triangle. A graphical
representation of model <a href="#equation-disastermodel">(?)</a> follows: <img class="math" src="_images/math/9ffb448918db29f2a72f8f87f421b3b3cad18f95.png" alt="D"/> is shaded
because it is flagged as data.</p>
<p>The symbol for factor potentials is a rectangle, as in the following model.
Factor potentials are usually associated with <em>undirected</em> grahical models. In
undirected representations, each parent of a potential is connected to every
other parent by an undirected edge. The undirected representation of the model
pictured above is much more compact: Directed or mixed graphical models can be
represented in an undirected form by &#8216;moralizing&#8217;, which is done by the function
<tt class="docutils literal"><span class="pre">pymc.graph.moral_graph</span></tt>.</p>
</div>
<div class="section" id="class-lazyfunction-and-caching">
<span id="sec-caching"></span><h2>4.7. Class LazyFunction and caching<a class="headerlink" href="#class-lazyfunction-and-caching" title="Permalink to this headline">¶</a></h2>
<p>This section gives an overview of how PyMC computes log-probabilities. This is
advanced information that is not required in order to use PyMC.</p>
<p>The <tt class="docutils literal"><span class="pre">logp</span></tt> attributes of stochastic variables and potentials and the <tt class="docutils literal"><span class="pre">value</span></tt>
attributes of deterministic variables are wrappers for instances of class
<tt class="docutils literal"><span class="pre">LazyFunction</span></tt>. Lazy functions are wrappers for ordinary Python functions. A
lazy function <tt class="docutils literal"><span class="pre">L</span></tt> could be created from a function <tt class="docutils literal"><span class="pre">fun</span></tt> as follows:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">L</span> <span class="o">=</span> <span class="n">LazyFunction</span><span class="p">(</span><span class="n">fun</span><span class="p">,</span> <span class="n">arguments</span><span class="p">)</span>
</pre></div>
</div>
<p>The argument <tt class="docutils literal"><span class="pre">arguments</span></tt> is a dictionary container; <tt class="docutils literal"><span class="pre">fun</span></tt> must accept
keyword arguments only. When <tt class="docutils literal"><span class="pre">L</span></tt>&#8216;s <tt class="docutils literal"><span class="pre">get()</span></tt> method is called, the return
value is the same as the call</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">fun</span><span class="p">(</span><span class="o">**</span><span class="n">arguments</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
</pre></div>
</div>
<p>Note that no arguments need to be passed to <tt class="docutils literal"><span class="pre">L.get</span></tt>; lazy functions memorize
their arguments.</p>
<p>Before calling <tt class="docutils literal"><span class="pre">fun</span></tt>, <tt class="docutils literal"><span class="pre">L</span></tt> will check the values of <tt class="docutils literal"><span class="pre">arguments.variables</span></tt>
against an internal cache. This comparison is done <em>by reference</em>, not by value,
and this is part of the reason why stochastic variables&#8217; values cannot be
updated in-place. If <tt class="docutils literal"><span class="pre">arguments.variables</span></tt>&#8216; values match a frame of the cache,
the corresponding output value is returned and <tt class="docutils literal"><span class="pre">fun</span></tt> is not called. If a call
to <tt class="docutils literal"><span class="pre">fun</span></tt> is needed, <tt class="docutils literal"><span class="pre">arguments.variables</span></tt>&#8216; values and the return value
replace the oldest frame in the cache. The depth of the cache can be set using
the optional init argument <tt class="docutils literal"><span class="pre">cache_depth</span></tt>, which defaults to 2.</p>
<p>Caching is helpful in MCMC, because variables&#8217; log-probabilities and values tend
to be queried multiple times for the same parental value configuration. The
default cache depth of 2 turns out to be most useful in Metropolis-Hastings-type
algorithms involving proposed values that may be rejected.</p>
<p>Lazy functions are implemented in C using Pyrex, a language for writing Python
extensions.</p>
<p class="rubric">Footnotes</p>
<table class="docutils footnote" frame="void" id="id10" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td>Note that the <tt class="docutils literal"><span class="pre">random</span></tt> method does not provide a Gibbs sample unless the
variable has no children.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id11" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id3">[2]</a></td><td>Note that deterministic variables have no <tt class="docutils literal"><span class="pre">observed</span></tt> flag. If a deterministic
variable&#8217;s value were known, its parents would be restricted to the inverse
image of that value under the deterministic variable&#8217;s evaluation function. This
usage would be extremely difficult to support in general, but it can be
implemented for particular applications at the <tt class="docutils literal"><span class="pre">StepMethod</span></tt> level.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id12" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id4">[3]</a></td><td>Nodes whose parents are containers make private shallow copies of those
containers. This is done for technical reasons rather than to protect users from
accidental misuse.</td></tr>
</tbody>
</table>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="index.html">
              <img class="logo" src="_static/icon_small.png" alt="Logo"/>
            </a></p>
            <h3><a href="index.html">Table Of Contents</a></h3>
            <ul>
<li><a class="reference external" href="">4. Building models</a><ul>
<li><a class="reference external" href="#the-stochastic-class">4.1. The Stochastic class</a><ul>
<li><a class="reference external" href="#creation-of-stochastic-variables">4.1.1. Creation of stochastic variables</a></li>
</ul>
</li>
<li><a class="reference external" href="#data">4.2. Data</a><ul>
<li><a class="reference external" href="#declaring-stochastic-variables-to-be-data">4.2.1. Declaring stochastic variables to be data</a></li>
</ul>
</li>
<li><a class="reference external" href="#the-deterministic-class">4.3. The Deterministic class</a><ul>
<li><a class="reference external" href="#creation-of-deterministic-variables">4.3.1. Creation of deterministic variables</a></li>
</ul>
</li>
<li><a class="reference external" href="#containers">4.4. Containers</a></li>
<li><a class="reference external" href="#the-potential-class">4.5. The Potential class</a><ul>
<li><a class="reference external" href="#an-example-of-soft-data">4.5.1. An example of soft data</a></li>
<li><a class="reference external" href="#creation-of-potentials">4.5.2. Creation of Potentials</a></li>
</ul>
</li>
<li><a class="reference external" href="#graphing-models">4.6. Graphing models</a></li>
<li><a class="reference external" href="#class-lazyfunction-and-caching">4.7. Class LazyFunction and caching</a></li>
</ul>
</li>
</ul>

            <h4>Previous topic</h4>
            <p class="topless"><a href="tutorial.html"
                                  title="previous chapter">3. Tutorial</a></p>
            <h4>Next topic</h4>
            <p class="topless"><a href="references.html"
                                  title="next chapter">5. References</a></p>
            <h3>This Page</h3>
            <ul class="this-page-menu">
              <li><a href="_sources/modelbuilding.txt"
                     rel="nofollow">Show Source</a></li>
            </ul>
          <div id="searchbox" style="display: none">
            <h3>Quick search</h3>
              <form class="search" action="search.html" method="get">
                <input type="text" name="q" size="18" />
                <input type="submit" value="Go" />
                <input type="hidden" name="check_keywords" value="yes" />
                <input type="hidden" name="area" value="default" />
              </form>
              <p class="searchtip" style="font-size: 90%">
              Enter search terms or a module, class or function name.
              </p>
          </div>
          <script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="references.html" title="5. References"
             >next</a> |</li>
        <li class="right" >
          <a href="tutorial.html" title="3. Tutorial"
             >previous</a> |</li>
        <li><a href="index.html">pymc v2.0 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
      &copy; Copyright 2008, Chris Fonnesbeck, Anand Patil, David Huard.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 0.7.
    </div>
  </body>
</html>