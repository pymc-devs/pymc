

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Rolling Regression &mdash; pymc3 3.0 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="pymc3 3.0 documentation" href="../../index.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> pymc3
          

          
          </a>

          
            
            
              <div class="version">
                3.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul>
<li class="toctree-l1"><a class="reference internal" href="../../examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">API Reference</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../index.html">pymc3</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          

 



<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../index.html">Docs</a> &raquo;</li>
      
    <li>Rolling Regression</li>
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../../_sources/notebooks/.ipynb_checkpoints/rolling_regression-checkpoint.txt" rel="nofollow"> View page source</a>
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput,
div.nbinput > div,
div.nbinput div[class^=highlight],
div.nbinput div[class^=highlight] pre,
div.nboutput,
div.nboutput > div,
div.nboutput div[class^=highlight],
div.nboutput div[class^=highlight] pre {
    background: none;
    border: none;
    padding: 0 0;
    margin: 0;
    box-shadow: none;
}

/* avoid gaps between output lines */
div.nboutput div[class^=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput,
div.nboutput {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
}

/* input container */
div.nbinput {
    padding-top: 5px;
}

/* last container */
div.nblast {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput > :first-child pre {
    color: #303F9F;
}

/* output prompt */
div.nboutput > :first-child pre {
    color: #D84315;
}

/* all prompts */
div.nbinput > :first-child[class^=highlight],
div.nboutput > :first-child[class^=highlight],
div.nboutput > :first-child {
    min-width: 11ex;
    padding-top: 0.4em;
    padding-right: 0.4em;
    text-align: right;
    flex: 0;
}

/* input/output area */
div.nbinput > :nth-child(2)[class^=highlight],
div.nboutput > :nth-child(2),
div.nboutput > :nth-child(2)[class^=highlight] {
    padding: 0.4em;
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}

/* input area */
div.nbinput > :nth-child(2)[class^=highlight] {
    border: 1px solid #cfcfcf;
    border-radius: 2px;
    background: #f7f7f7;
}

/* override MathJax center alignment in output cells */
div.nboutput div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.pngmath center alignment in output cells */
div.nboutput div.math p {
    text-align: left;
}

/* standard error */
div.nboutput  > :nth-child(2).stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-bold { font-weight: bold; }

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast,
.nboutput.nblast {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast + .nbinput {
    margin-top: -19px;
}

/* nice headers on first paragraph of info/warning boxes */
.admonition .first {
    margin: -12px;
    padding: 6px 12px;
    margin-bottom: 12px;
    color: #fff;
    line-height: 1;
    display: block;
}
.admonition.warning .first {
    background: #f0b37e;
}
.admonition.note .first {
    background: #6ab0de;
}
.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}
</style>
<div class="section" id="Rolling-Regression">
<h1>Rolling Regression<a class="headerlink" href="#Rolling-Regression" title="Permalink to this headline">¶</a></h1>
<p>Author: Thomas Wiecki</p>
<ul class="simple">
<li><a class="reference external" href="https://www.quantopian.com/posts/pairs-trading-algorithm-1">Pairs
trading</a>
is a famous technique in algorithmic trading that plays two stocks
against each other.</li>
<li>For this to work, stocks must be correlated (cointegrated).</li>
<li>One common example is the price of gold (GLD) and the price of gold
mining operations (GDX).</li>
</ul>
<div class="nbinput nblast container">
<div class="highlight-none"><div class="highlight"><pre>
<span></span>In [11]:
</pre></div>
</div>
<div class="highlight-ipython3"><div class="highlight"><pre>
<span></span>%matplotlib inline
import pandas as pd
from pandas_datareader import data
import numpy as np
import pymc3 as pm
import matplotlib.pyplot as plt
</pre></div>
</div>
</div>
<p>Lets load the prices of GDX and GLD.</p>
<div class="nbinput container">
<div class="highlight-none"><div class="highlight"><pre>
<span></span>In [32]:
</pre></div>
</div>
<div class="highlight-ipython3"><div class="highlight"><pre>
<span></span>prices = data.YahooDailyReader(symbols=[&#39;GLD&#39;, &#39;GDX&#39;], end=&#39;2014-8-1&#39;).read().loc[&#39;Adj Close&#39;, :, :].iloc[:1000]
prices.head()
</pre></div>
</div>
</div>
<div class="nboutput nblast container">
<div class="highlight-none"><div class="highlight"><pre>
<span></span>Out[32]:
</pre></div>
</div>
<div class="container">
<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>GDX</th>
      <th>GLD</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2010-01-04</th>
      <td>45.642212</td>
      <td>109.800003</td>
    </tr>
    <tr>
      <th>2010-01-05</th>
      <td>46.082275</td>
      <td>109.699997</td>
    </tr>
    <tr>
      <th>2010-01-06</th>
      <td>47.201568</td>
      <td>111.510002</td>
    </tr>
    <tr>
      <th>2010-01-07</th>
      <td>46.971968</td>
      <td>110.820000</td>
    </tr>
    <tr>
      <th>2010-01-08</th>
      <td>47.679898</td>
      <td>111.370003</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>Plotting the prices over time suggests a strong correlation. However,
the correlation seems to change over time.</p>
<div class="nbinput container">
<div class="highlight-none"><div class="highlight"><pre>
<span></span>In [33]:
</pre></div>
</div>
<div class="highlight-ipython3"><div class="highlight"><pre>
<span></span>fig = plt.figure(figsize=(9, 6))
ax = fig.add_subplot(111, xlabel=&#39;Price GDX in \$&#39;, ylabel=&#39;Price GLD in \$&#39;)
colors = np.linspace(0.1, 1, len(prices))
mymap = plt.get_cmap(&quot;winter&quot;)
sc = ax.scatter(prices.GDX, prices.GLD, c=colors, cmap=mymap, lw=0)
cb = plt.colorbar(sc)
cb.ax.set_yticklabels([str(p.date()) for p in prices[::len(prices)//10].index]);
</pre></div>
</div>
</div>
<div class="nboutput nblast container">
<div class="container">
</div>
<div class="container">
<img alt="notebooks/.ipynb_checkpoints/../../_build/.doctrees/nbsphinx/notebooks_.ipynb_checkpoints_rolling_regression-checkpoint_5_0.png" src="notebooks/.ipynb_checkpoints/../../_build/.doctrees/nbsphinx/notebooks_.ipynb_checkpoints_rolling_regression-checkpoint_5_0.png" />
</div>
</div>
<p>A naive approach would be to estimate a linear model and ignore the time
domain.</p>
<div class="nbinput container">
<div class="highlight-none"><div class="highlight"><pre>
<span></span>In [42]:
</pre></div>
</div>
<div class="highlight-ipython3"><div class="highlight"><pre>
<span></span>with pm.Model() as model_reg:
    pm.glm.glm(&#39;GLD ~ GDX&#39;, prices)
    trace_reg = pm.sample(2000)
</pre></div>
</div>
</div>
<div class="nboutput nblast container">
<div class="container">
</div>
<div class="container">
<div class="highlight"><pre>
Assigned NUTS to Intercept
Assigned NUTS to GDX
Assigned NUTS to sd_log
 [-----------------100%-----------------] 2000 of 2000 complete in 6.4 sec
</pre></div></div>
</div>
<p>The posterior predictive plot shows how bad the fit is.</p>
<div class="nbinput container">
<div class="highlight-none"><div class="highlight"><pre>
<span></span>In [43]:
</pre></div>
</div>
<div class="highlight-ipython3"><div class="highlight"><pre>
<span></span>fig = plt.figure(figsize=(9, 6))
ax = fig.add_subplot(111, xlabel=&#39;Price GDX in \$&#39;, ylabel=&#39;Price GLD in \$&#39;,
            title=&#39;Posterior predictive regression lines&#39;)
sc = ax.scatter(prices.GDX, prices.GLD, c=colors, cmap=mymap, lw=0)
pm.glm.plot_posterior_predictive(trace_reg[100:], samples=100,
                              label=&#39;posterior predictive regression lines&#39;,
                              lm=lambda x, sample: sample[&#39;Intercept&#39;] + sample[&#39;GDX&#39;] * x,
                              eval=np.linspace(prices.GDX.min(), prices.GDX.max(), 100))
cb = plt.colorbar(sc)
cb.ax.set_yticklabels([str(p.date()) for p in prices[::len(prices)//10].index]);
ax.legend(loc=0);
</pre></div>
</div>
</div>
<div class="nboutput nblast container">
<div class="container">
</div>
<div class="container">
<img alt="notebooks/.ipynb_checkpoints/../../_build/.doctrees/nbsphinx/notebooks_.ipynb_checkpoints_rolling_regression-checkpoint_9_0.png" src="notebooks/.ipynb_checkpoints/../../_build/.doctrees/nbsphinx/notebooks_.ipynb_checkpoints_rolling_regression-checkpoint_9_0.png" />
</div>
</div>
<div class="section" id="Rolling-regression">
<h2>Rolling regression<a class="headerlink" href="#Rolling-regression" title="Permalink to this headline">¶</a></h2>
<p>Next, we will build an improved model that will allow for changes in the
regression coefficients over time. Specifically, we will assume that
intercept and slope follow a random-walk through time. That idea is
similar to the <a class="reference external" href="http://pymc-devs.github.io/pymc3/stochastic_volatility/">stochastic volatility
model</a>.</p>
<div class="math">
\[\alpha_t \sim \mathcal{N}(\alpha_{t-1}, \sigma_\alpha^2)\]</div>
<div class="math">
\[\beta_t \sim \mathcal{N}(\beta_{t-1}, \sigma_\beta^2)\]</div>
<p>First, lets define the hyper-priors for <span class="math">\(\sigma_\alpha^2\)</span> and
<span class="math">\(\sigma_\beta^2\)</span>. This parameter can be interpreted as the
volatility in the regression coefficients.</p>
<div class="nbinput nblast container">
<div class="highlight-none"><div class="highlight"><pre>
<span></span>In [34]:
</pre></div>
</div>
<div class="highlight-ipython3"><div class="highlight"><pre>
<span></span>model_randomwalk = pm.Model()
with model_randomwalk:
    # std of random walk, best sampled in log space.
    sigma_alpha = pm.Exponential(&#39;sigma_alpha&#39;, 1./.02, testval = .1)
    sigma_beta = pm.Exponential(&#39;sigma_beta&#39;, 1./.02, testval = .1)
</pre></div>
</div>
</div>
<p>Next, we define the regression parameters that are not a single random
variable but rather a random vector with the above stated dependence
structure. So as not to fit a coefficient to a single data point, we
will chunk the data into bins of 50 and apply the same coefficients to
all data points in a single bin.</p>
<div class="nbinput nblast container">
<div class="highlight-none"><div class="highlight"><pre>
<span></span>In [36]:
</pre></div>
</div>
<div class="highlight-ipython3"><div class="highlight"><pre>
<span></span>import theano.tensor as T

# To make the model simpler, we will apply the same coefficient for 50 data points at a time
subsample_alpha = 50
subsample_beta = 50
with model_randomwalk:
    alpha = pm.GaussianRandomWalk(&#39;alpha&#39;, sigma_alpha**-2,
                                  shape=len(prices) // subsample_alpha)
    beta = pm.GaussianRandomWalk(&#39;beta&#39;, sigma_beta**-2,
                                 shape=len(prices) // subsample_beta)

    # Make coefficients have the same length as prices
    alpha_r = T.repeat(alpha, subsample_alpha)
    beta_r = T.repeat(beta, subsample_beta)
</pre></div>
</div>
</div>
<p>Perform the regression given coefficients and data and link to the data
via the likelihood.</p>
<div class="nbinput nblast container">
<div class="highlight-none"><div class="highlight"><pre>
<span></span>In [37]:
</pre></div>
</div>
<div class="highlight-ipython3"><div class="highlight"><pre>
<span></span>with model_randomwalk:
    # Define regression
    regression = alpha_r + beta_r * prices.GDX.values

    # Assume prices are Normally distributed, the mean comes from the regression.
    sd = pm.Uniform(&#39;sd&#39;, 0, 20)
    likelihood = pm.Normal(&#39;y&#39;,
                           mu=regression,
                           sd=sd,
                           observed=prices.GLD.values)
</pre></div>
</div>
</div>
<p>Inference. Despite this being quite a complex model, NUTS handles it
wells.</p>
<div class="nbinput nblast container">
<div class="highlight-none"><div class="highlight"><pre>
<span></span>In [38]:
</pre></div>
</div>
<div class="highlight-ipython3"><div class="highlight"><pre>
<span></span>from scipy import optimize
with model_randomwalk:
    # First optimize random walk
    start = pm.find_MAP(vars=[alpha, beta], fmin=optimize.fmin_l_bfgs_b)

    # Sample
    step = pm.NUTS(scaling=start)
    trace_rw = pm.sample(2000, step, start=start)
</pre></div>
</div>
</div>
</div>
<div class="section" id="Analysis-of-results">
<h2>Analysis of results<a class="headerlink" href="#Analysis-of-results" title="Permalink to this headline">¶</a></h2>
<p><span class="math">\(\alpha\)</span>, the intercept, does not seem to change over time.</p>
<div class="nbinput container">
<div class="highlight-none"><div class="highlight"><pre>
<span></span>In [39]:
</pre></div>
</div>
<div class="highlight-ipython3"><div class="highlight"><pre>
<span></span>fig = plt.figure(figsize=(8, 6))
ax = plt.subplot(111, xlabel=&#39;time&#39;, ylabel=&#39;alpha&#39;, title=&#39;Change of alpha over time.&#39;)
ax.plot(trace_rw[-1000:][alpha].T, &#39;r&#39;, alpha=.05);
ax.set_xticklabels([str(p.date()) for p in prices[::len(prices)//5].index]);
</pre></div>
</div>
</div>
<div class="nboutput nblast container">
<div class="container">
</div>
<div class="container">
<img alt="notebooks/.ipynb_checkpoints/../../_build/.doctrees/nbsphinx/notebooks_.ipynb_checkpoints_rolling_regression-checkpoint_21_0.png" src="notebooks/.ipynb_checkpoints/../../_build/.doctrees/nbsphinx/notebooks_.ipynb_checkpoints_rolling_regression-checkpoint_21_0.png" />
</div>
</div>
<p>However, the slope does.</p>
<div class="nbinput container">
<div class="highlight-none"><div class="highlight"><pre>
<span></span>In [40]:
</pre></div>
</div>
<div class="highlight-ipython3"><div class="highlight"><pre>
<span></span>fig = plt.figure(figsize=(8, 6))
ax = fig.add_subplot(111, xlabel=&#39;time&#39;, ylabel=&#39;beta&#39;, title=&#39;Change of beta over time&#39;)
ax.plot(trace_rw[-1000:][beta].T, &#39;b&#39;, alpha=.05);
ax.set_xticklabels([str(p.date()) for p in prices[::len(prices)//5].index]);
</pre></div>
</div>
</div>
<div class="nboutput nblast container">
<div class="container">
</div>
<div class="container">
<img alt="notebooks/.ipynb_checkpoints/../../_build/.doctrees/nbsphinx/notebooks_.ipynb_checkpoints_rolling_regression-checkpoint_23_0.png" src="notebooks/.ipynb_checkpoints/../../_build/.doctrees/nbsphinx/notebooks_.ipynb_checkpoints_rolling_regression-checkpoint_23_0.png" />
</div>
</div>
<p>The posterior predictive plot shows that we capture the change in
regression over time much better. Note that we should have used returns
instead of prices. The model would still work the same, but the
visualisations would not be quite as clear.</p>
<div class="nbinput container">
<div class="highlight-none"><div class="highlight"><pre>
<span></span>In [41]:
</pre></div>
</div>
<div class="highlight-ipython3"><div class="highlight"><pre>
<span></span>fig = plt.figure(figsize=(8, 6))
ax = fig.add_subplot(111, xlabel=&#39;Price GDX in \$&#39;, ylabel=&#39;Price GLD in \$&#39;,
            title=&#39;Posterior predictive regression lines&#39;)

colors = np.linspace(0.1, 1, len(prices))
colors_sc = np.linspace(0.1, 1, len(trace_rw[-500::10][&#39;alpha&#39;].T))
mymap = plt.get_cmap(&#39;winter&#39;)
mymap_sc = plt.get_cmap(&#39;winter&#39;)

xi = np.linspace(prices.GDX.min(), prices.GDX.max(), 50)
for i, (alpha, beta) in enumerate(zip(trace_rw[-500::10][&#39;alpha&#39;].T, trace_rw[-500::10][&#39;beta&#39;].T)):
    for a, b in zip(alpha, beta):
        ax.plot(xi, a + b*xi, alpha=.05, lw=1, c=mymap_sc(colors_sc[i]))

sc = ax.scatter(prices.GDX, prices.GLD, label=&#39;data&#39;, cmap=mymap, c=colors)
cb = plt.colorbar(sc)
cb.ax.set_yticklabels([str(p.date()) for p in prices[::len(prices)//10].index]);
</pre></div>
</div>
</div>
<div class="nboutput nblast container">
<div class="container">
</div>
<div class="container">
<img alt="notebooks/.ipynb_checkpoints/../../_build/.doctrees/nbsphinx/notebooks_.ipynb_checkpoints_rolling_regression-checkpoint_25_0.png" src="notebooks/.ipynb_checkpoints/../../_build/.doctrees/nbsphinx/notebooks_.ipynb_checkpoints_rolling_regression-checkpoint_25_0.png" />
</div>
</div>
</div>
</div>


           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015, John Salvatier and Christopher Fonnesbeck.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'3.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>