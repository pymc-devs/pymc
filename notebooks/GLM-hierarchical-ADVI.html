

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>The best of both worlds: Hierarchical Linear Regression in PyMC3 &mdash; pymc3 3.0 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="pymc3 3.0 documentation" href="../index.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> pymc3
          

          
          </a>

          
            
            
              <div class="version">
                3.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul>
<li class="toctree-l1"><a class="reference internal" href="../examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api.html">API Reference</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../index.html">pymc3</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          

 



<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html">Docs</a> &raquo;</li>
      
    <li>The best of both worlds: Hierarchical Linear Regression in PyMC3</li>
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/notebooks/GLM-hierarchical-ADVI.txt" rel="nofollow"> View page source</a>
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput,
div.nbinput > div,
div.nbinput div[class^=highlight],
div.nbinput div[class^=highlight] pre,
div.nboutput,
div.nboutput > div,
div.nboutput div[class^=highlight],
div.nboutput div[class^=highlight] pre {
    background: none;
    border: none;
    padding: 0 0;
    margin: 0;
    box-shadow: none;
}

/* avoid gaps between output lines */
div.nboutput div[class^=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput,
div.nboutput {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
}

/* input container */
div.nbinput {
    padding-top: 5px;
}

/* last container */
div.nblast {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput > :first-child pre {
    color: #303F9F;
}

/* output prompt */
div.nboutput > :first-child pre {
    color: #D84315;
}

/* all prompts */
div.nbinput > :first-child[class^=highlight],
div.nboutput > :first-child[class^=highlight],
div.nboutput > :first-child {
    min-width: 11ex;
    padding-top: 0.4em;
    padding-right: 0.4em;
    text-align: right;
    flex: 0;
}

/* input/output area */
div.nbinput > :nth-child(2)[class^=highlight],
div.nboutput > :nth-child(2),
div.nboutput > :nth-child(2)[class^=highlight] {
    padding: 0.4em;
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}

/* input area */
div.nbinput > :nth-child(2)[class^=highlight] {
    border: 1px solid #cfcfcf;
    border-radius: 2px;
    background: #f7f7f7;
}

/* override MathJax center alignment in output cells */
div.nboutput div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.pngmath center alignment in output cells */
div.nboutput div.math p {
    text-align: left;
}

/* standard error */
div.nboutput  > :nth-child(2).stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-bold { font-weight: bold; }

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast,
.nboutput.nblast {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast + .nbinput {
    margin-top: -19px;
}

/* nice headers on first paragraph of info/warning boxes */
.admonition .first {
    margin: -12px;
    padding: 6px 12px;
    margin-bottom: 12px;
    color: #fff;
    line-height: 1;
    display: block;
}
.admonition.warning .first {
    background: #f0b37e;
}
.admonition.note .first {
    background: #6ab0de;
}
.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}
</style>
<div class="section" id="The-best-of-both-worlds:-Hierarchical-Linear-Regression-in-PyMC3">
<h1>The best of both worlds: Hierarchical Linear Regression in PyMC3<a class="headerlink" href="#The-best-of-both-worlds:-Hierarchical-Linear-Regression-in-PyMC3" title="Permalink to this headline">¶</a></h1>
<p>First, we&#8217;ll load the data:</p>
<div class="nbinput nblast container">
<div class="highlight-none"><div class="highlight"><pre>
<span></span>In [1]:
</pre></div>
</div>
<div class="highlight-ipython3"><div class="highlight"><pre>
<span></span>%matplotlib inline
import matplotlib.pyplot as plt
import numpy as np
import pymc3 as pm
import pandas as pd

data = pd.read_csv(&#39;../data/radon.csv&#39;)

county_names = data.county.unique()
county_idx = data[&#39;county_code&#39;].values
n_counties = len(data.county.unique())
</pre></div>
</div>
</div>
<div class="nbinput container">
<div class="highlight-none"><div class="highlight"><pre>
<span></span>In [2]:
</pre></div>
</div>
<div class="highlight-ipython3"><div class="highlight"><pre>
<span></span>with pm.Model() as hierarchical_model:
    # Hyperpriors for group nodes
    mu_a = pm.Normal(&#39;mu_alpha&#39;, mu=0., sd=100**2)
    sigma_a = pm.Uniform(&#39;sigma_alpha&#39;, lower=0, upper=100)
    mu_b = pm.Normal(&#39;mu_beta&#39;, mu=0., sd=100**2)
    sigma_b = pm.Uniform(&#39;sigma_beta&#39;, lower=0, upper=100)

    # Intercept for each county, distributed around group mean mu_a
    # Above we just set mu and sd to a fixed value while here we
    # plug in a common group distribution for all a and b (which are
    # vectors of length n_counties).
    a = pm.Normal(&#39;alpha&#39;, mu=mu_a, sd=sigma_a, shape=n_counties)
    # Intercept for each county, distributed around group mean mu_a
    b = pm.Normal(&#39;beta&#39;, mu=mu_b, sd=sigma_b, shape=n_counties)

    # Model error
    eps = pm.Uniform(&#39;eps&#39;, lower=0, upper=100)

    # Model prediction of radon level
    # a[county_idx] translates to a[0, 0, 0, 1, 1, ...],
    # we thus link multiple household measures of a county
    # to its coefficients.
    radon_est = a[county_idx] + b[county_idx] * data.floor.values

    # Data likelihood
    radon_like = pm.Normal(&#39;radon_like&#39;, mu=radon_est, sd=eps, observed=data.log_radon)
</pre></div>
</div>
</div>
<div class="nboutput nblast container">
<div class="container">
</div>
<div class="container">
<div class="highlight"><pre>
Applied interval-transform to sigma_alpha and added transformed sigma_alpha_interval to model.
Applied interval-transform to sigma_beta and added transformed sigma_beta_interval to model.
Applied interval-transform to eps and added transformed eps_interval to model.
</pre></div></div>
</div>
<div class="nbinput container">
<div class="highlight-none"><div class="highlight"><pre>
<span></span>In [3]:
</pre></div>
</div>
<div class="highlight-ipython3"><div class="highlight"><pre>
<span></span>with hierarchical_model:
    means, sds, elbos = pm.variational.advi(n=100000)
</pre></div>
</div>
</div>
<div class="nboutput nblast container">
<div class="container">
</div>
<div class="container">
<div class="highlight"><pre>
Iteration 0 [0%]: ELBO = -5348.9
Iteration 10000 [10%]: ELBO = -2928.73
Iteration 20000 [20%]: ELBO = -1604.67
Iteration 30000 [30%]: ELBO = -1158.49
Iteration 40000 [40%]: ELBO = -1104.15
Iteration 50000 [50%]: ELBO = -1088.61
Iteration 60000 [60%]: ELBO = -1091.37
Iteration 70000 [70%]: ELBO = -1102.58
Iteration 80000 [80%]: ELBO = -1108.43
Iteration 90000 [90%]: ELBO = -1086.84
Finished [100%]: ELBO = -1100.34
</pre></div></div>
</div>
<div class="nbinput nblast container">
<div class="highlight-none"><div class="highlight"><pre>
<span></span>In [4]:
</pre></div>
</div>
<div class="highlight-ipython3"><div class="highlight"><pre>
<span></span># Inference button (TM)!
with hierarchical_model:
    #start = pm.find_MAP()
    step = pm.NUTS(scaling=means)
    hierarchical_trace = pm.sample(5000, step, start=means, progressbar=False)
</pre></div>
</div>
</div>
<div class="nbinput container">
<div class="highlight-none"><div class="highlight"><pre>
<span></span>In [5]:
</pre></div>
</div>
<div class="highlight-ipython3"><div class="highlight"><pre>
<span></span>from scipy import stats
import seaborn as sns
varnames = means.keys()
fig, axs = plt.subplots(nrows=len(varnames), figsize=(12, 18))
for var, ax in zip(varnames, axs):
    mu_arr = means[var]
    sigma_arr = sds[var]
    ax.set_title(var)
    for i, (mu, sigma) in enumerate(zip(mu_arr.flatten(), sigma_arr.flatten())):
        sd3 = (-4*sigma + mu, 4*sigma + mu)
        x = np.linspace(sd3[0], sd3[1], 300)
        y = stats.norm(mu, sigma).pdf(x)
        ax.plot(x, y)
        if hierarchical_trace[var].ndim &gt; 1:
            t = hierarchical_trace[var][i]
        else:
            t = hierarchical_trace[var]
        sns.distplot(t, kde=False, norm_hist=True, ax=ax)
fig.tight_layout()
</pre></div>
</div>
</div>
<div class="nboutput nblast container">
<div class="container">
</div>
<div class="container">
<img alt="notebooks/../_build/.doctrees/nbsphinx/notebooks_GLM-hierarchical-ADVI_6_0.png" src="notebooks/../_build/.doctrees/nbsphinx/notebooks_GLM-hierarchical-ADVI_6_0.png" />
</div>
</div>
<p>Plotting the hierarchical model trace -its found values- from 500
iterations onwards (right side plot) and its accumulated marginal values
(left side plot)</p>
<div class="nbinput container">
<div class="highlight-none"><div class="highlight"><pre>
<span></span>In [6]:
</pre></div>
</div>
<div class="highlight-ipython3"><div class="highlight"><pre>
<span></span>pm.traceplot(hierarchical_trace[500:]);
</pre></div>
</div>
</div>
<div class="nboutput nblast container">
<div class="container">
</div>
<div class="container">
<img alt="notebooks/../_build/.doctrees/nbsphinx/notebooks_GLM-hierarchical-ADVI_8_0.png" src="notebooks/../_build/.doctrees/nbsphinx/notebooks_GLM-hierarchical-ADVI_8_0.png" />
</div>
</div>
<p>The marginal posteriors in the left column are highly informative.
<code class="docutils literal"><span class="pre">mu_a</span></code> tells us the group mean (log) radon levels. <code class="docutils literal"><span class="pre">mu_b</span></code> tells us
that having no basement decreases radon levels significantly (no mass
above zero). We can also see by looking at the marginals for <code class="docutils literal"><span class="pre">a</span></code> that
there is quite some differences in radon levels between counties (each
&#8216;rainbow&#8217; color corresponds to a single county); the different widths
are related to how much confidence we have in each paramter estimate &#8211;
the more measurements per county, the higher our confidence will be.</p>
</div>
<div class="section" id="Posterior-Predictive-Check">
<h1>Posterior Predictive Check<a class="headerlink" href="#Posterior-Predictive-Check" title="Permalink to this headline">¶</a></h1>
<div class="section" id="The-Root-Mean-Square-Deviation">
<h2>The Root Mean Square Deviation<a class="headerlink" href="#The-Root-Mean-Square-Deviation" title="Permalink to this headline">¶</a></h2>
<p>To find out which of the models explains the data better we can
calculate the Root Mean Square Deviaton (RMSD). This posterior
predictive check revolves around recreating the data based on the
parameters found at different moments in the chain. The recreated or
predicted values are subsequently compared to the real data points, the
model that predicts data points closer to the original data is
considered the better one. Thus, the lower the RMSD the better.</p>
<p>When computing the RMSD (code not shown) we get the following result:</p>
<ul class="simple">
<li>individual/non-hierarchical model: 0.13</li>
<li>hierarchical model: 0.08</li>
</ul>
<p>As can be seen above the hierarchical model performs better than the
non-hierarchical model in predicting the radon values. Following this,
we&#8217;ll plot some examples of county&#8217;s showing the actual radon
measurements, the hierarchial predictions and the non-hierarchical
predictions.</p>
<div class="nbinput container">
<div class="highlight-none"><div class="highlight"><pre>
<span></span>In [9]:
</pre></div>
</div>
<div class="highlight-ipython3"><div class="highlight"><pre>
<span></span># Non-hierarchical model runs
selection = [&#39;CASS&#39;, &#39;CROW WING&#39;, &#39;FREEBORN&#39;]

indiv_traces = {}
for county_name in selection:
    # Select subset of data belonging to county
    c_data = data.ix[data.county == county_name]
    c_log_radon = c_data.log_radon
    c_floor_measure = c_data.floor.values

    with pm.Model() as individual_model:
        # Intercept prior (variance == sd**2)
        a = pm.Normal(&#39;alpha&#39;, mu=0, sd=100**2)
        # Slope prior
        b = pm.Normal(&#39;beta&#39;, mu=0, sd=100**2)

        # Model error prior
        eps = pm.Uniform(&#39;eps&#39;, lower=0, upper=100)

        # Linear model
        radon_est = a + b * c_floor_measure

        # Data likelihood
        radon_like = pm.Normal(&#39;radon_like&#39;, mu=radon_est, sd=eps, observed=c_log_radon)

        # Inference button (TM)!
        trace = pm.sample(2000, progressbar=False)

    # keep trace for later analysis
    indiv_traces[county_name] = trace
</pre></div>
</div>
</div>
<div class="nboutput nblast container">
<div class="container">
</div>
<div class="container">
<div class="highlight"><pre>
Applied interval-transform to eps and added transformed eps_interval to model.
Assigned NUTS to alpha
Assigned NUTS to beta
Assigned NUTS to eps_interval
Applied interval-transform to eps and added transformed eps_interval to model.
Assigned NUTS to alpha
Assigned NUTS to beta
Assigned NUTS to eps_interval
Applied interval-transform to eps and added transformed eps_interval to model.
Assigned NUTS to alpha
Assigned NUTS to beta
Assigned NUTS to eps_interval
</pre></div></div>
</div>
<div class="nbinput container">
<div class="highlight-none"><div class="highlight"><pre>
<span></span>In [11]:
</pre></div>
</div>
<div class="highlight-ipython3"><div class="highlight"><pre>
<span></span>fig, axis = plt.subplots(1, 3, figsize=(12, 6), sharey=True, sharex=True)
axis = axis.ravel()
for i, c in enumerate(selection):
    c_data = data.ix[data.county == c]
    c_ind = np.where(county_names==c)[0][0]
    c_data = c_data.reset_index(drop = True)
    z = list(c_data[&#39;county_code&#39;])[0]

    xvals = np.linspace(-0.2, 1.2)
    for a_val, b_val in zip(indiv_traces[c][&#39;alpha&#39;][500:], indiv_traces[c][&#39;beta&#39;][500:]):
        axis[i].plot(xvals, a_val + b_val * xvals, &#39;b&#39;, alpha=.1)
    axis[i].plot(xvals, indiv_traces[c][&#39;alpha&#39;][500:].mean() + indiv_traces[c][&#39;beta&#39;][500:].mean() * xvals,
                 &#39;b&#39;, alpha=1, lw=2., label=&#39;individual&#39;)
    for a_val, b_val in zip(hierarchical_trace[&#39;alpha&#39;][500:][z], hierarchical_trace[&#39;beta&#39;][500:][z]):
        axis[i].plot(xvals, a_val + b_val * xvals, &#39;g&#39;, alpha=.1)
    axis[i].plot(xvals, hierarchical_trace[&#39;alpha&#39;][500:][z].mean() + hierarchical_trace[&#39;beta&#39;][500:][z].mean() * xvals,
                 &#39;g&#39;, alpha=1, lw=2., label=&#39;hierarchical&#39;)
    axis[i].scatter(c_data.floor + np.random.randn(len(c_data))*0.01, c_data.log_radon,
                    alpha=1, color=&#39;k&#39;, marker=&#39;.&#39;, s=80, label=&#39;original data&#39;)
    axis[i].set_xticks([0,1])
    axis[i].set_xticklabels([&#39;basement&#39;, &#39;no basement&#39;])
    axis[i].set_ylim(-1, 4)
    axis[i].set_title(c)
    if not i%3:
        axis[i].legend()
        axis[i].set_ylabel(&#39;log radon level&#39;)
</pre></div>
</div>
</div>
<div class="nboutput nblast container">
<div class="container">
</div>
<div class="container">
<img alt="notebooks/../_build/.doctrees/nbsphinx/notebooks_GLM-hierarchical-ADVI_12_0.png" src="notebooks/../_build/.doctrees/nbsphinx/notebooks_GLM-hierarchical-ADVI_12_0.png" />
</div>
</div>
<p>In the above plot we have the data points in black of three selected
counties. The thick lines represent the mean estimate of the regression
line of the individual (blue) and hierarchical model (in green). The
thinner lines are regression lines of individual samples from the
posterior and give us a sense of how variable the estimates are.</p>
<p>When looking at the county &#8216;CASS&#8217; we see that the non-hierarchical
estimation is strongly biased: as this county&#8217;s data contains only
households with a basement the estimated regression produces the
non-sensical result of a giant negative slope meaning that we would
expect negative radon levels in a house without basement!</p>
<p>Moreover, in the example county&#8217;s &#8216;CROW WING&#8217; and &#8216;FREEBORN&#8217; the
non-hierarchical model appears to react more strongly than the
hierarchical model to the existance of outliers in the dataset (&#8216;CROW
WING&#8217;: no basement upper right. &#8216;FREEBORN&#8217;: basement upper left).
Assuming that there should be a higher amount of radon gas measurable in
households with basements opposed to those without, the county &#8216;CROW
WING&#8217;&#8217;s non-hierachical model seems off. Having the group-distribution
constrain the coefficients we get meaningful estimates in all cases as
we apply what we learn from the group to the individuals and vice-versa.</p>
</div>
</div>


           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015, John Salvatier and Christopher Fonnesbeck.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'3.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>