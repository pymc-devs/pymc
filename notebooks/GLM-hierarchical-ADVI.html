

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>The best of both worlds: Hierarchical Linear Regression in PyMC3 &mdash; PyMC3 3.0 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="PyMC3 3.0 documentation" href="../index.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> PyMC3
          

          
          </a>

          
            
            
              <div class="version">
                3.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul>
<li class="toctree-l1"><a class="reference internal" href="../getting_started.html">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api.html">API Reference</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../index.html">PyMC3</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          

 



<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html">Docs</a> &raquo;</li>
      
    <li>The best of both worlds: Hierarchical Linear Regression in PyMC3</li>
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/notebooks/GLM-hierarchical-ADVI.txt" rel="nofollow"> View page source</a>
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast,
.nboutput.nblast {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast + .nbinput {
    margin-top: -19px;
}

/* nice headers on first paragraph of info/warning boxes */
.admonition .first {
    margin: -12px;
    padding: 6px 12px;
    margin-bottom: 12px;
    color: #fff;
    line-height: 1;
    display: block;
}
.admonition.warning .first {
    background: #f0b37e;
}
.admonition.note .first {
    background: #6ab0de;
}
.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}
</style>
<div class="section" id="the-best-of-both-worlds-hierarchical-linear-regression-in-pymc3">
<span id="the-best-of-both-worlds-hierarchical-linear-regression-in-pymc3"></span><h1>The best of both worlds: Hierarchical Linear Regression in PyMC3<a class="headerlink" href="#the-best-of-both-worlds-hierarchical-linear-regression-in-pymc3" title="Permalink to this headline">¶</a></h1>
<p>First, we&#8217;ll load the data:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="o">%</span><span class="n">matplotlib</span> <span class="n">inline</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pymc3</span> <span class="kn">as</span> <span class="nn">pm</span> 
<span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;../data/radon.csv&#39;</span><span class="p">)</span>

<span class="n">county_names</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">county</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
<span class="n">county_idx</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;county_code&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<span class="n">n_counties</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">county</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">pm</span><span class="o">.</span><span class="n">Model</span><span class="p">()</span> <span class="k">as</span> <span class="n">hierarchical_model</span><span class="p">:</span>
    <span class="c1"># Hyperpriors for group nodes</span>
    <span class="n">mu_a</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s1">&#39;mu_alpha&#39;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">sd</span><span class="o">=</span><span class="mi">100</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">sigma_a</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Uniform</span><span class="p">(</span><span class="s1">&#39;sigma_alpha&#39;</span><span class="p">,</span> <span class="n">lower</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">mu_b</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s1">&#39;mu_beta&#39;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">sd</span><span class="o">=</span><span class="mi">100</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">sigma_b</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Uniform</span><span class="p">(</span><span class="s1">&#39;sigma_beta&#39;</span><span class="p">,</span> <span class="n">lower</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    
    <span class="c1"># Intercept for each county, distributed around group mean mu_a</span>
    <span class="c1"># Above we just set mu and sd to a fixed value while here we</span>
    <span class="c1"># plug in a common group distribution for all a and b (which are</span>
    <span class="c1"># vectors of length n_counties).</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s1">&#39;alpha&#39;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">mu_a</span><span class="p">,</span> <span class="n">sd</span><span class="o">=</span><span class="n">sigma_a</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">n_counties</span><span class="p">)</span>
    <span class="c1"># Intercept for each county, distributed around group mean mu_a</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s1">&#39;beta&#39;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">mu_b</span><span class="p">,</span> <span class="n">sd</span><span class="o">=</span><span class="n">sigma_b</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">n_counties</span><span class="p">)</span>
    
    <span class="c1"># Model error</span>
    <span class="n">eps</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Uniform</span><span class="p">(</span><span class="s1">&#39;eps&#39;</span><span class="p">,</span> <span class="n">lower</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    
    <span class="c1"># Model prediction of radon level</span>
    <span class="c1"># a[county_idx] translates to a[0, 0, 0, 1, 1, ...],</span>
    <span class="c1"># we thus link multiple household measures of a county</span>
    <span class="c1"># to its coefficients.</span>
    <span class="n">radon_est</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">county_idx</span><span class="p">]</span> <span class="o">+</span> <span class="n">b</span><span class="p">[</span><span class="n">county_idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">data</span><span class="o">.</span><span class="n">floor</span><span class="o">.</span><span class="n">values</span>
    
    <span class="c1"># Data likelihood</span>
    <span class="n">radon_like</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s1">&#39;radon_like&#39;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">radon_est</span><span class="p">,</span> <span class="n">sd</span><span class="o">=</span><span class="n">eps</span><span class="p">,</span> <span class="n">observed</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">log_radon</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">Applied</span> <span class="n">interval</span><span class="o">-</span><span class="n">transform</span> <span class="n">to</span> <span class="n">sigma_alpha</span> <span class="ow">and</span> <span class="n">added</span> <span class="n">transformed</span> <span class="n">sigma_alpha_interval</span> <span class="n">to</span> <span class="n">model</span><span class="o">.</span>
<span class="n">Applied</span> <span class="n">interval</span><span class="o">-</span><span class="n">transform</span> <span class="n">to</span> <span class="n">sigma_beta</span> <span class="ow">and</span> <span class="n">added</span> <span class="n">transformed</span> <span class="n">sigma_beta_interval</span> <span class="n">to</span> <span class="n">model</span><span class="o">.</span>
<span class="n">Applied</span> <span class="n">interval</span><span class="o">-</span><span class="n">transform</span> <span class="n">to</span> <span class="n">eps</span> <span class="ow">and</span> <span class="n">added</span> <span class="n">transformed</span> <span class="n">eps_interval</span> <span class="n">to</span> <span class="n">model</span><span class="o">.</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">hierarchical_model</span><span class="p">:</span>
    <span class="n">means</span><span class="p">,</span> <span class="n">sds</span><span class="p">,</span> <span class="n">elbos</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">variational</span><span class="o">.</span><span class="n">advi</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">100000</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">Iteration</span> <span class="mi">0</span> <span class="p">[</span><span class="mi">0</span><span class="o">%</span><span class="p">]:</span> <span class="n">ELBO</span> <span class="o">=</span> <span class="o">-</span><span class="mf">5348.9</span>
<span class="n">Iteration</span> <span class="mi">10000</span> <span class="p">[</span><span class="mi">10</span><span class="o">%</span><span class="p">]:</span> <span class="n">ELBO</span> <span class="o">=</span> <span class="o">-</span><span class="mf">2928.73</span>
<span class="n">Iteration</span> <span class="mi">20000</span> <span class="p">[</span><span class="mi">20</span><span class="o">%</span><span class="p">]:</span> <span class="n">ELBO</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1604.67</span>
<span class="n">Iteration</span> <span class="mi">30000</span> <span class="p">[</span><span class="mi">30</span><span class="o">%</span><span class="p">]:</span> <span class="n">ELBO</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1158.49</span>
<span class="n">Iteration</span> <span class="mi">40000</span> <span class="p">[</span><span class="mi">40</span><span class="o">%</span><span class="p">]:</span> <span class="n">ELBO</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1104.15</span>
<span class="n">Iteration</span> <span class="mi">50000</span> <span class="p">[</span><span class="mi">50</span><span class="o">%</span><span class="p">]:</span> <span class="n">ELBO</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1088.61</span>
<span class="n">Iteration</span> <span class="mi">60000</span> <span class="p">[</span><span class="mi">60</span><span class="o">%</span><span class="p">]:</span> <span class="n">ELBO</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1091.37</span>
<span class="n">Iteration</span> <span class="mi">70000</span> <span class="p">[</span><span class="mi">70</span><span class="o">%</span><span class="p">]:</span> <span class="n">ELBO</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1102.58</span>
<span class="n">Iteration</span> <span class="mi">80000</span> <span class="p">[</span><span class="mi">80</span><span class="o">%</span><span class="p">]:</span> <span class="n">ELBO</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1108.43</span>
<span class="n">Iteration</span> <span class="mi">90000</span> <span class="p">[</span><span class="mi">90</span><span class="o">%</span><span class="p">]:</span> <span class="n">ELBO</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1086.84</span>
<span class="n">Finished</span> <span class="p">[</span><span class="mi">100</span><span class="o">%</span><span class="p">]:</span> <span class="n">ELBO</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1100.34</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># Inference button (TM)!</span>
<span class="k">with</span> <span class="n">hierarchical_model</span><span class="p">:</span>
    <span class="c1">#start = pm.find_MAP()</span>
    <span class="n">step</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">NUTS</span><span class="p">(</span><span class="n">scaling</span><span class="o">=</span><span class="n">means</span><span class="p">)</span>
    <span class="n">hierarchical_trace</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="mi">5000</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">means</span><span class="p">,</span> <span class="n">progressbar</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="kn">as</span> <span class="nn">sns</span>
<span class="n">varnames</span> <span class="o">=</span> <span class="n">means</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">varnames</span><span class="p">),</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">18</span><span class="p">))</span>
<span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">varnames</span><span class="p">,</span> <span class="n">axs</span><span class="p">):</span>
    <span class="n">mu_arr</span> <span class="o">=</span> <span class="n">means</span><span class="p">[</span><span class="n">var</span><span class="p">]</span>
    <span class="n">sigma_arr</span> <span class="o">=</span> <span class="n">sds</span><span class="p">[</span><span class="n">var</span><span class="p">]</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">mu_arr</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">sigma_arr</span><span class="o">.</span><span class="n">flatten</span><span class="p">())):</span>
        <span class="n">sd3</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">4</span><span class="o">*</span><span class="n">sigma</span> <span class="o">+</span> <span class="n">mu</span><span class="p">,</span> <span class="mi">4</span><span class="o">*</span><span class="n">sigma</span> <span class="o">+</span> <span class="n">mu</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">sd3</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">sd3</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">300</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">hierarchical_trace</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">hierarchical_trace</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">hierarchical_trace</span><span class="p">[</span><span class="n">var</span><span class="p">]</span>
        <span class="n">sns</span><span class="o">.</span><span class="n">distplot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">kde</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">norm_hist</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
<p><img alt="png" src="../_images/GLM-hierarchical-ADVI_6_0.png" /></p>
<p>Plotting the hierarchical model trace -its found values- from 500 iterations onwards (right side plot) and its accumulated marginal values (left side plot)</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">pm</span><span class="o">.</span><span class="n">traceplot</span><span class="p">(</span><span class="n">hierarchical_trace</span><span class="p">[</span><span class="mi">500</span><span class="p">:]);</span>
</pre></div>
</div>
<p><img alt="png" src="../_images/GLM-hierarchical-ADVI_8_0.png" /></p>
<p>The marginal posteriors in the left column are highly informative. <code class="docutils literal"><span class="pre">mu_a</span></code> tells us the group mean (log) radon levels. <code class="docutils literal"><span class="pre">mu_b</span></code> tells us that having no basement decreases radon levels significantly (no mass above zero). We can also see by looking at the marginals for <code class="docutils literal"><span class="pre">a</span></code> that there is quite some differences in radon levels between counties (each &#8216;rainbow&#8217; color corresponds to a single county); the different widths are related to how much confidence we have in each paramter estimate &#8211; the more measurements per county, the higher our confidence will be.</p>
</div>
<div class="section" id="posterior-predictive-check">
<span id="posterior-predictive-check"></span><h1>Posterior Predictive Check<a class="headerlink" href="#posterior-predictive-check" title="Permalink to this headline">¶</a></h1>
<div class="section" id="the-root-mean-square-deviation">
<span id="the-root-mean-square-deviation"></span><h2>The Root Mean Square Deviation<a class="headerlink" href="#the-root-mean-square-deviation" title="Permalink to this headline">¶</a></h2>
<p>To find out which of the models explains the data better we can calculate the Root Mean Square Deviaton (RMSD). This posterior predictive check revolves around recreating the data based on the parameters found at different moments in the chain. The recreated or predicted values are subsequently compared to the real data points, the model that predicts data points closer to the original data is considered the better one. Thus, the lower the RMSD the better.</p>
<p>When computing the RMSD (code not shown) we get the following result:</p>
<ul class="simple">
<li>individual/non-hierarchical model: 0.13</li>
<li>hierarchical model: 0.08</li>
</ul>
<p>As can be seen above the hierarchical model performs better than the non-hierarchical model in predicting the radon values. Following this, we&#8217;ll plot some examples of county&#8217;s showing the actual radon measurements, the hierarchial predictions and the non-hierarchical predictions.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># Non-hierarchical model runs</span>
<span class="n">selection</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;CASS&#39;</span><span class="p">,</span> <span class="s1">&#39;CROW WING&#39;</span><span class="p">,</span> <span class="s1">&#39;FREEBORN&#39;</span><span class="p">]</span>

<span class="n">indiv_traces</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">county_name</span> <span class="ow">in</span> <span class="n">selection</span><span class="p">:</span>
    <span class="c1"># Select subset of data belonging to county</span>
    <span class="n">c_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">county</span> <span class="o">==</span> <span class="n">county_name</span><span class="p">]</span>
    <span class="n">c_log_radon</span> <span class="o">=</span> <span class="n">c_data</span><span class="o">.</span><span class="n">log_radon</span>
    <span class="n">c_floor_measure</span> <span class="o">=</span> <span class="n">c_data</span><span class="o">.</span><span class="n">floor</span><span class="o">.</span><span class="n">values</span>
    
    <span class="k">with</span> <span class="n">pm</span><span class="o">.</span><span class="n">Model</span><span class="p">()</span> <span class="k">as</span> <span class="n">individual_model</span><span class="p">:</span>
        <span class="c1"># Intercept prior (variance == sd**2)</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s1">&#39;alpha&#39;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sd</span><span class="o">=</span><span class="mi">100</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="c1"># Slope prior</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s1">&#39;beta&#39;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sd</span><span class="o">=</span><span class="mi">100</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    
        <span class="c1"># Model error prior</span>
        <span class="n">eps</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Uniform</span><span class="p">(</span><span class="s1">&#39;eps&#39;</span><span class="p">,</span> <span class="n">lower</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    
        <span class="c1"># Linear model</span>
        <span class="n">radon_est</span> <span class="o">=</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span> <span class="o">*</span> <span class="n">c_floor_measure</span>
    
        <span class="c1"># Data likelihood</span>
        <span class="n">radon_like</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s1">&#39;radon_like&#39;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">radon_est</span><span class="p">,</span> <span class="n">sd</span><span class="o">=</span><span class="n">eps</span><span class="p">,</span> <span class="n">observed</span><span class="o">=</span><span class="n">c_log_radon</span><span class="p">)</span>

        <span class="c1"># Inference button (TM)!</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span> <span class="n">progressbar</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    
    <span class="c1"># keep trace for later analysis</span>
    <span class="n">indiv_traces</span><span class="p">[</span><span class="n">county_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">trace</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">Applied</span> <span class="n">interval</span><span class="o">-</span><span class="n">transform</span> <span class="n">to</span> <span class="n">eps</span> <span class="ow">and</span> <span class="n">added</span> <span class="n">transformed</span> <span class="n">eps_interval</span> <span class="n">to</span> <span class="n">model</span><span class="o">.</span>
<span class="n">Assigned</span> <span class="n">NUTS</span> <span class="n">to</span> <span class="n">alpha</span>
<span class="n">Assigned</span> <span class="n">NUTS</span> <span class="n">to</span> <span class="n">beta</span>
<span class="n">Assigned</span> <span class="n">NUTS</span> <span class="n">to</span> <span class="n">eps_interval</span>
<span class="n">Applied</span> <span class="n">interval</span><span class="o">-</span><span class="n">transform</span> <span class="n">to</span> <span class="n">eps</span> <span class="ow">and</span> <span class="n">added</span> <span class="n">transformed</span> <span class="n">eps_interval</span> <span class="n">to</span> <span class="n">model</span><span class="o">.</span>
<span class="n">Assigned</span> <span class="n">NUTS</span> <span class="n">to</span> <span class="n">alpha</span>
<span class="n">Assigned</span> <span class="n">NUTS</span> <span class="n">to</span> <span class="n">beta</span>
<span class="n">Assigned</span> <span class="n">NUTS</span> <span class="n">to</span> <span class="n">eps_interval</span>
<span class="n">Applied</span> <span class="n">interval</span><span class="o">-</span><span class="n">transform</span> <span class="n">to</span> <span class="n">eps</span> <span class="ow">and</span> <span class="n">added</span> <span class="n">transformed</span> <span class="n">eps_interval</span> <span class="n">to</span> <span class="n">model</span><span class="o">.</span>
<span class="n">Assigned</span> <span class="n">NUTS</span> <span class="n">to</span> <span class="n">alpha</span>
<span class="n">Assigned</span> <span class="n">NUTS</span> <span class="n">to</span> <span class="n">beta</span>
<span class="n">Assigned</span> <span class="n">NUTS</span> <span class="n">to</span> <span class="n">eps_interval</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">sharey</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">axis</span> <span class="o">=</span> <span class="n">axis</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">selection</span><span class="p">):</span>
    <span class="n">c_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">county</span> <span class="o">==</span> <span class="n">c</span><span class="p">]</span>
    <span class="n">c_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">county_names</span><span class="o">==</span><span class="n">c</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">c_data</span> <span class="o">=</span> <span class="n">c_data</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
    <span class="n">z</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">c_data</span><span class="p">[</span><span class="s1">&#39;county_code&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">xvals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">a_val</span><span class="p">,</span> <span class="n">b_val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">indiv_traces</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="s1">&#39;alpha&#39;</span><span class="p">][</span><span class="mi">500</span><span class="p">:],</span> <span class="n">indiv_traces</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="s1">&#39;beta&#39;</span><span class="p">][</span><span class="mi">500</span><span class="p">:]):</span>
        <span class="n">axis</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xvals</span><span class="p">,</span> <span class="n">a_val</span> <span class="o">+</span> <span class="n">b_val</span> <span class="o">*</span> <span class="n">xvals</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=.</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">axis</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xvals</span><span class="p">,</span> <span class="n">indiv_traces</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="s1">&#39;alpha&#39;</span><span class="p">][</span><span class="mi">500</span><span class="p">:]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">+</span> <span class="n">indiv_traces</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="s1">&#39;beta&#39;</span><span class="p">][</span><span class="mi">500</span><span class="p">:]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="n">xvals</span><span class="p">,</span> 
                 <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">2.</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;individual&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">a_val</span><span class="p">,</span> <span class="n">b_val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">hierarchical_trace</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">][</span><span class="mi">500</span><span class="p">:][</span><span class="n">z</span><span class="p">],</span> <span class="n">hierarchical_trace</span><span class="p">[</span><span class="s1">&#39;beta&#39;</span><span class="p">][</span><span class="mi">500</span><span class="p">:][</span><span class="n">z</span><span class="p">]):</span>
        <span class="n">axis</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xvals</span><span class="p">,</span> <span class="n">a_val</span> <span class="o">+</span> <span class="n">b_val</span> <span class="o">*</span> <span class="n">xvals</span><span class="p">,</span> <span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=.</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">axis</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xvals</span><span class="p">,</span> <span class="n">hierarchical_trace</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">][</span><span class="mi">500</span><span class="p">:][</span><span class="n">z</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">+</span> <span class="n">hierarchical_trace</span><span class="p">[</span><span class="s1">&#39;beta&#39;</span><span class="p">][</span><span class="mi">500</span><span class="p">:][</span><span class="n">z</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="n">xvals</span><span class="p">,</span> 
                 <span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">2.</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;hierarchical&#39;</span><span class="p">)</span>
    <span class="n">axis</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">c_data</span><span class="o">.</span><span class="n">floor</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">c_data</span><span class="p">))</span><span class="o">*</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">c_data</span><span class="o">.</span><span class="n">log_radon</span><span class="p">,</span> 
                    <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;original data&#39;</span><span class="p">)</span>
    <span class="n">axis</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">axis</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s1">&#39;basement&#39;</span><span class="p">,</span> <span class="s1">&#39;no basement&#39;</span><span class="p">])</span>
    <span class="n">axis</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
    <span class="n">axis</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">i</span><span class="o">%</span><span class="mi">3</span><span class="p">:</span>
        <span class="n">axis</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">axis</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;log radon level&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p><img alt="png" src="../_images/GLM-hierarchical-ADVI_12_0.png" /></p>
<p>In the above plot we have the data points in black of three selected counties. The thick lines represent the mean estimate of the regression line of the individual (blue) and hierarchical model (in green). The thinner lines are regression lines of individual samples from the posterior and give us a sense of how variable the estimates are.</p>
<p>When looking at the county &#8216;CASS&#8217; we see that the non-hierarchical estimation is strongly biased: as this county&#8217;s data contains only households with a basement the estimated regression produces the non-sensical result of a giant negative slope meaning that we would expect negative radon levels in a house without basement!</p>
<p>Moreover, in the example county&#8217;s &#8216;CROW WING&#8217; and &#8216;FREEBORN&#8217; the non-hierarchical model appears to react more strongly than the hierarchical model to the existance of outliers in the dataset (&#8216;CROW WING&#8217;: no basement upper right. &#8216;FREEBORN&#8217;: basement upper left). Assuming that there should be a higher amount of radon gas measurable in households with basements opposed to those without, the county &#8216;CROW WING&#8217;&#8217;s non-hierachical model seems off. Having the group-distribution constrain the coefficients we get meaningful estimates in all cases as we apply what we learn from the group to the individuals and vice-versa.</p>
</div>
</div>


           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016, John Salvatier, Christopher Fonnesbeck, Thomas Wiecki.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'3.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>